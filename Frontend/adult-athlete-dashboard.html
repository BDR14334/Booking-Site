<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Athlete Dashboard</title>
  <!-- Poppins & Icons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #333940;
      margin: 0;
      padding: 0;
      color: white;
    }
    header {
      background-color: #1e1e1e;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
    }
    section h1 {
      text-align: center;
      font-size: 30px
    }
    #sidebarLinksContainer a {
      margin-left: 15px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 20px 8px;
      transition: background 0.2s, color 0.2s;
    }
    #sidebarLinksContainer a:hover {
      background-color: #333940;
      color: #fff;
    }
    section {
      padding: 30px 20px;
      max-width: 1000px;
      margin: auto;
    }
    h2 {
      margin-bottom: 20px;
      color: #fff;
    }

    form {
      display: flex;
      flex-direction: column;
      align-items: flex-start; /* Left-align labels and fields */
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    form label {
      display: block;
      margin: 10px 0 5px 8px;
      font-weight: 600;
      font-size: 1rem;
      text-align: left;
      width: 100%;
    }
    form input,
    form textarea,
    form select {
      width: 100%;
      font-size: 1rem;
      padding: 6px;
      border-radius: 5px;
      border: none;
      margin-bottom: 18px;
      box-sizing: border-box;
      background: #fff;
      color: #222;
    }
    button {
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #e03e00;
    }
    select {
      width: 102%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border-radius: 0.5rem;
      background-color: white;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    select:focus {
      border-color: #ff4800;
      outline: none;
      background-color: white;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    ul li {
      background: #444;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

    #calendar {
      width: 97%;
      background-color: white;
      padding: 20px;
      width: 300px;
      box-sizing: border-box;
      color: white;
      text-align: center;
    }
    .book-calendly-btn {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .book-calendly-btn:hover {
      background-color: #e03e00;
    }
    .back-btn {
      font-family: Arial, Helvetica, sans-serif;
      position: fixed;
      top: 90px;
      right: 20px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      text-shadow: 0 2px 8px rgb(0, 0, 0); 
      z-index: 99;
    }
    .back-btn:hover{
      color:#ff4800;
    }
    #editInfo {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }
    #infoForm {
      width: 60%;
      margin: 0 auto;
    }
    @media (max-width: 400px) {
      .athlete-box-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
    }
    @media (max-width: 1024px) {
      .material-symbols-outlined {
        font-size: 2.5rem !important;
      }
      form label {
        font-size: 1.2rem;
      }
      form input,
      form textarea,
      form select {
        font-size: 1rem;
        padding: 14px;
      }
      select {
        color:#000;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.25rem;
      }
      .athlete-box {
        padding: 45px;
        width: 350px;
        margin-left: auto;
        margin-right: auto;
      }
      button {
        font-size: 1rem;
      }
      #profileBtn {
        background: #333940;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 22px;
        transition: background 0.2s;
      }
      #profileBtn:hover {
        background: #ff4800;
        color: #fff;
      }
      .sidebar {
          position: fixed;
          top: 0;
          right: 0;
          width: 275px;
          height: 100%;
          background-color: #343a40;
          box-shadow: -10px 0 20px #24282c;
          padding-top: 1rem;
          display: none;
          z-index: 999;
          transition: all 0.3s ease-in-out;
      }
      .sidebar a {
          padding: 10px 20px;
          color: white;
          display: block;
          text-decoration: none;
          transition: background-color 0.3s ease;
      }
      .sidebar a:hover {
          background-color: #495057;
      }
      .sidebar-link-margin {
          margin-top: 0.6rem !important;
      }
      .close-btn {
          background-color: #ff4800;
          color: white;
          position: absolute;
          top: 1rem;
          right: 10px;
          padding: 2.5px 5px;
          border-radius: 50px;
          border: none;
      }
      #sidebarLinksContainer {
        display: none !important;
      }
      #profileBtn {
        display: inline-block !important;
      }
    }

    .booking-btn {
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .booking-btn:hover {
      background-color: #e03e00;
      color: #fff;
    }
    
    .athlete-box-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;   /* <-- Add this line */
      align-items: center;        /* Optional: vertical centering */
    }

    .athlete-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      box-sizing: border-box;
      color: white;
      text-align: center;
      justify-content: center;
    }

    .athlete-box input[name="athleteName"] {
      width: 95%; /* or any smaller value you want */
    }

  </style>
</head>
<body>
<header>
  <h1>Athlete Dashboard</h1>
  <nav id="sidebarLinksContainer">
    <a href="#editInfo">ðŸ“‹ Edit Info</a>
    <a href="#bookSessions">ðŸ“¦ Book Sessions</a>
    <a href="#" id="sidebarLogoutBtn" class="text-danger px-3 py-2 text-decoration-none">ðŸšª Logout</a>
  </nav>
  <button id="profileBtn" class="btn btn-outline-light" style="display:none;">
    <i class="bx bx-user"></i>
  </button>
</header>

<div id="profileSidebar" class="sidebar bg-dark text-white" style="display:none;">
  <button class="btn btn-sm btn-outline-light ms-2 mt-2 close-btn" onclick="toggleSidebar()">Ã— Close</button>
  <div class="mt-4 d-flex flex-column">
    <a style="margin-top: 20px;" href="#editInfo">ðŸ“‹ Edit Info</a>
    <a href="#bookSessions">ðŸ“¦ Book Sessions</a>
    <a href="#" id="logoutBtn" class="text-danger px-3 py-2 text-decoration-none">ðŸšª Logout</a>
  </div>
</div>

<div id="globalBackBtn" class="back-btn" onclick="handleBackClick()">
  <i class="fas fa-arrow-left">Back to Home</i>
</div>

<!-- Edit Personal Info -->
<section id="editInfo">
  <h1>Personal Info for Booking</h1>
  <p style="text-align:center; max-width:600px; margin:0 auto 30px auto; color:#fff; font-size:.9rem; text-shadow:0 2px 8px #000;">
    Please ensure your information is accurate to avoid booking issues. <br>
    You can update this info anytime.
  </p>
  <form id="athleteForm">
    <label for="athleteName">Name</label>
    <input type="text" id="athleteName" name="athleteName" required />

    <label for="email">Email</label>
    <input
      type="email"
      id="email"
      name="email"
      required
      pattern="^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$"
      placeholder="Enter your email"
      oninvalid="this.setCustomValidity('Please enter a valid email address.')"
      oninput="this.setCustomValidity('')"
    />

    <label for="phone">Phone</label>
    <input
      type="tel"
      id="phone"
      name="phone"
      required
      pattern="^\d{10,15}$"
      inputmode="tel"
      maxlength="15"
      placeholder="Enter phone number (digits only)"
      oninvalid="this.setCustomValidity('Please enter a valid phone number (digits only, 10-15 digits).')"
      oninput="this.setCustomValidity('')"
    />

    <label for="dob">Date of Birth</label>
    <input type="date" id="dob" name="dob" required />
  
    <label for="sport">Level of Activity Daily</label>
    <select id="sport" name="sport" required>
      <option value="" selected>--</option>
      <option value="Highly Active">Highly Active</option>
      <option value="Moderately Active">Moderately Active</option>
      <option value="Not Active">Not Active</option>
    </select>

    <button type="submit">Save Info</button>
  </form>
</section>

<!-- Book Sessions (PAID PACKAGES ONLY) -->
<section id="bookSessions">
  <h1>Book Your Sessions</h1>
  <div id="packageBookingContainer" class="athlete-box-container"></div>
  <div style="text-align:center; margin-top: 30px;">
    <button
      class="booking-btn"
      onclick="window.location.href='/booking'"
      style="font-size:1.2rem; padding:12px 32px; border-radius:8px; margin-top:10px;"
    >
      Explore Packages
    </button>
  </div>
</section>

<script src="authStatus.js"></script>
<script>
  // Redirect to login if not authenticated
  if (!localStorage.getItem("token")) {
    window.location.href = "/login";
  }

  (async function checkRole() {
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_BASE}/auth/me`, {
      credentials: 'include',
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    if (!data.user || data.user.role !== 'adult-athlete') {
      alert('Not authorized for Adult Athlete Dashboard');
      window.location.href = "/login";
    }
  })();

  function handleBackClick() {
     window.location.href = "/";
  }

  let userId = null;
  let customerId = null;
  let athleteId = null;

  document.getElementById('athleteForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const fullName = document.getElementById("athleteName").value.trim();
    const [first_name, ...lastNameParts] = fullName.split(' ');
    const last_name = lastNameParts.join(' ') || '';
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const dob = document.getElementById("dob").value;
    const sport = document.getElementById("sport").value;

    const phoneRegex = /^\d{10,15}$/;
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    if (!phoneRegex.test(phone)) {
      alert("Please enter a valid phone number (digits only, 10-15 digits).");
      return;
    }
    if (!emailRegex.test(email)) {
      alert("Please enter a valid email address.");
      return;
    }

    // Make sure we have userId first
    if (!userId) {
      await fetchLoggedInUser();
    }

    const method = customerId ? 'PUT' : 'POST';
    const url = customerId
      ? `${API_BASE}/athlete/adult-athlete/update/${customerId}`
      : `${API_BASE}/athlete/adult-athlete/create`;

    try {
      const response = await fetch(url, {
        method,
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          first_name,
          last_name,
          dob,
          email,
          phone,
          sport,
          user_id: userId
        }),
      });

      const data = await response.json();
      if (response.ok) {
        alert('âœ… Athlete info saved successfully!');
        customerId = data.customer?.id || data.customer?.customer_id || customerId;
        athleteId = data.athlete?.id || data.athlete?.athlete_id || athleteId;

        console.log("Saved adult athlete:", { customerId, athleteId });
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      console.error('Fetch error:', error);
      alert('Something went wrong saving athlete info!');
    }
  });

  // Fetch logged-in user
  async function fetchLoggedInUser() {
    try {
      const token = localStorage.getItem("token");

      const res = await fetch(`${API_BASE}/auth/me`, {
        credentials: 'include', // try sending cookie
        headers: token ? { Authorization: `Bearer ${token}` } : {} // fallback to header
      });
      const data = await res.json();
      if (data.user && data.user.id) {
        userId = data.user.id;
      } else {
        throw new Error('User data not found');
      }
    } catch (error) {
      alert('Session expired or unauthorized. Please log in again.');
      window.location.href = "/login";
    }
  }

  // Load athlete info
  async function loadCustomerData() {
    await fetchLoggedInUser();
    const token = localStorage.getItem("token");

    try {
      const athleteRes = await fetch(`${API_BASE}/athlete/adult-athlete/by-user/${userId}`, {
        credentials: 'include',
        headers: token ? { Authorization: `Bearer ${token}` } : {}
      });
      const athlete = await athleteRes.json();

      // âœ… Store both IDs
      customerId = athlete.customer_id;
      athleteId = athlete.athlete_id;

      // Populate form fields
      document.getElementById("athleteName").value =
        (athlete.first_name || "") + (athlete.last_name ? " " + athlete.last_name : "");
      document.getElementById("email").value = athlete.email || "";
      document.getElementById("phone").value = athlete.phone || "";
      const dob = athlete.dob ? athlete.dob.split('T')[0] : "";
      document.getElementById("dob").value = dob;

      const sportMap = {
        "highly active": "Highly Active",
        "moderately active": "Moderately Active",
        "moderatly active": "Moderately Active",
        "not active": "Not Active"
      };
      const sportValue = sportMap[(athlete.sport || "").toLowerCase().trim()] || "";
      document.getElementById("sport").value = sportValue;
    } catch (error) {
      console.error('Error loading client data:', error);
    }
  }

  function toggleSidebar() {
    const sidebar = document.getElementById("profileSidebar");
    sidebar.style.display = sidebar.style.display === "block" ? "none" : "block";
  }

  document.getElementById("profileBtn").onclick = toggleSidebar;

  // Hide sidebar when clicking outside
  document.addEventListener("click", function (event) {
    const sidebar = document.getElementById("profileSidebar");
    const profileBtn = document.getElementById("profileBtn");
    if (
      sidebar.style.display === "block" &&
      !sidebar.contains(event.target) &&
      !(profileBtn && profileBtn.contains(event.target))
    ) {
      sidebar.style.display = "none";
    }
  });

  async function handleLogout() {
    try {      // Hit your logout route to clear the cookie

      // Hit your logout route to clear the cookie
      const token = localStorage.getItem("token");
      fetch(`${API_BASE}/auth/logout`, {
        method: 'POST',
        credentials: 'include',
        headers: token ? { Authorization: `Bearer ${token}` } : {}
      });
    } catch (err) {
      console.error("Logout request failed:", err);
    }

    // Clear frontend tokens
    localStorage.removeItem("token");
    sessionStorage.clear();

    // Redirect to homepage
    window.location.href = "/";
  }

  // Load paid packages for booking
  async function loadPaidPackages() {
    if (!customerId) {
      const container = document.getElementById('packageBookingContainer');
      container.innerHTML = `
        <div class="athlete-box">
          Please complete your profile before booking.<br>
          Go to <strong>Personal Info</strong> above.
        </div>
      `;
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/athlete/paid-packages/${customerId}`, { credentials: 'include' });
      const packages = await res.json();

      const container = document.getElementById('packageBookingContainer');
      container.innerHTML = '';

      if (packages.length > 0) {
        const infoP = document.createElement('p');
        infoP.style.textAlign = "center";
        infoP.style.maxWidth = "550px";
        infoP.style.margin = "0 auto 24px auto";
        infoP.style.color = "#fff";
        infoP.style.fontSize = ".9rem";
        infoP.style.textShadow = "0 2px 8px #000";
        infoP.innerHTML = `Select<strong> "Click to Schedule"</strong> on your package. Calendly will open choose your timeslot and confirm. <br><br>Need more sessions? Click <strong>"Explore Packages"</strong> below.`;
        container.parentNode.insertBefore(infoP, container);
      } else {
        // Remove the instructional text if present
        const prev = container.previousElementSibling;
        if (prev && prev.tagName === "P" && prev.innerHTML.includes("Click to Schedule")) {
          prev.remove();
        }
        // Show the "no packages" box
        container.innerHTML = `
          <div class="athlete-box">
            No paid packages found.<br>
            Click <strong>Explore Packages</strong> to purchase a package and schedule sessions.
          </div>
        `;
      }

      packages.forEach(pkg => {
        const box = document.createElement('div');
        box.className = 'athlete-box';

        box.innerHTML = `
          <h3>${pkg.name}</h3>
          <p>Sessions Remaining: ${pkg.sessions_remaining ?? 'N/A'}</p>
          <button class="book-calendly-btn" onclick="window.open('${pkg.calendly_url}', '_blank')">
            Click to Schedule
          </button>
        `;
        container.appendChild(box);
      });
    } catch (err) {
      console.error('Error loading paid packages:', err);
      document.getElementById('packageBookingContainer').innerHTML = '<p>Error loading packages.</p>';
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadCustomerData();
    await loadPaidPackages();

    document.getElementById("logoutBtn")?.addEventListener("click", function(e) {
      e.preventDefault();
      handleLogout();
    });
    document.getElementById("sidebarLogoutBtn")?.addEventListener("click", function(e) {
      e.preventDefault();
      handleLogout();
    });
  });

  async function autofillAthleteInfoIfFirstLogin() {
    if (localStorage.getItem("athleteAutofilled") === "true") {
      return;
    }
    const token = localStorage.getItem("token");
    try {
      const res = await fetch(`${API_BASE}/athlete/me`, {
        method: 'GET',
        headers: token ? { Authorization: `Bearer ${token}` } : {},
        credentials: 'include'
      });
      if (!res.ok) return;
      const data = await res.json();
      const nameInput = document.getElementById("athleteName");
      const emailInput = document.getElementById("email");
      if (nameInput && !nameInput.value) {
        nameInput.value = `${data.first_name || ""} ${data.last_name || ""}`.trim();
      }
      if (emailInput && !emailInput.value) {
        emailInput.value = data.email || "";
      }
      localStorage.setItem("athleteAutofilled", "true");
    } catch (err) {
      console.error("Failed to autofill athlete info", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    autofillAthleteInfoIfFirstLogin();
  });

  document.addEventListener("DOMContentLoaded", function() {
    if (window.location.hash === "#bookSessions") {
      setTimeout(() => {
        const el = document.getElementById("bookSessions");
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "start" });
          // Optionally scroll a bit more:
          setTimeout(() => window.scrollBy(0, 100), 400); // scroll 100px lower
        }
      }, 300);
    }
  });
</script>

<div id="firstLoginPopup" style="
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #343a40;
  color: white;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
  z-index: 9999;
  font-size: 18px;
  text-align: center;
  max-width: 400px;
">
  <p id="firstLoginMessage">Welcome! Please complete your profile before booking sessions.</p>
  <button onclick="closeFirstLoginPopup()" style="
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #ff4800;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  ">OK</button>
</div>

</body>
</html>
