<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <!-- Poppins & Icons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #333940;
      margin: 0;
      padding: 0;
      color: white;
    }
    header {
      background-color: #1e1e1e;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
    }
    section h1 {
      text-align: center;
      font-size: 30px
    }
    #sidebarLinksContainer a {
      margin-left: 15px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 20px 8px;
      transition: background 0.2s, color 0.2s;
    }
    #sidebarLinksContainer a:hover {
      background-color: #333940;
      color: #fff;
    }
    section {
      padding: 30px 20px;
      max-width: 1000px;
      margin: auto;
    }
    h2 {
      margin-bottom: 20px;
      color: #fff;
    }

    form {
      display: flex;
      flex-direction: column;
      align-items: flex-start; /* Left-align labels and fields */
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    form label {
      display: block;
      margin: 10px 0 5px 8px;
      font-weight: 600;
      font-size: 1rem;
      text-align: left;
      width: 100%;
    }
    form input,
    form textarea,
    form select {
      width: 100%;
      font-size: 1rem;
      padding: 6px;
      border-radius: 5px;
      border: none;
      margin-bottom: 18px;
      box-sizing: border-box;
      background: #fff;
      color: #222;
    }
    button {
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #e03e00;
    }
    select {
      width: 102%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border-radius: 0.5rem;
      background-color: white;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    select:focus {
      border-color: #ff4800;
      outline: none;
      background-color: white;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    ul li {
      background: #444;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

    #calendar {
      width: 97%;
      background-color: white;
      padding: 20px;
      width: 300px;
      box-sizing: border-box;
      color: white;
      text-align: center;
    }
    .book-calendly-btn {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .book-calendly-btn:hover {
      background-color: #e03e00;
    }
    .back-btn {
      font-family: Arial, Helvetica, sans-serif;
      position: fixed;
      top: 90px;
      right: 20px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      text-shadow: 0 2px 8px rgb(0, 0, 0); 
      z-index: 99;
    }
    .back-btn:hover{
      color:#ff4800;
    }
    #editInfo {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }
    #infoForm {
      width: 60%;
      margin: 0 auto;
    }
    @media (max-width: 400px) {
      .athlete-box-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
    }
    @media (max-width: 1024px) {
      .material-symbols-outlined {
        font-size: 2.5rem !important;
      }
      form label {
        font-size: 1.2rem;
      }
      form input,
      form textarea,
      form select {
        font-size: 1rem;
        padding: 14px;
      }
      select {
        color:#000;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.25rem;
      }
      .athlete-box {
        padding: 45px;
        width: 350px;
        margin-left: auto;
        margin-right: auto;
      }
      button {
        font-size: 1rem;
      }
      #profileBtn {
        background: #333940;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 22px;
        transition: background 0.2s;
      }
      #profileBtn:hover {
        background: #ff4800;
        color: #fff;
      }
      .sidebar {
          position: fixed;
          top: 0;
          right: 0;
          width: 275px;
          height: 100%;
          background-color: #343a40;
          box-shadow: -10px 0 20px #24282c;
          padding-top: 1rem;
          display: none;
          z-index: 999;
          transition: all 0.3s ease-in-out;
      }
      .sidebar a {
          padding: 10px 20px;
          color: white;
          display: block;
          text-decoration: none;
          transition: background-color 0.3s ease;
      }
      .sidebar a:hover {
          background-color: #495057;
      }
      .sidebar-link-margin {
          margin-top: 0.6rem !important;
      }
      .close-btn {
          background-color: #ff4800;
          color: white;
          position: absolute;
          top: 1rem;
          right: 10px;
          padding: 2.5px 5px;
          border-radius: 50px;
          border: none;
      }
      #sidebarLinksContainer {
        display: none !important;
      }
      #profileBtn {
        display: inline-block !important;
      }
    }

    .booking-btn {
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .booking-btn:hover {
      background-color: #e03e00;
      color: #fff;
    }
    
    .athlete-box-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;   /* <-- Add this line */
      align-items: center;        /* Optional: vertical centering */
    }

    .athlete-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      box-sizing: border-box;
      color: white;
      text-align: center;
      justify-content: center;
    }

    .athlete-box input[name="athleteName"] {
      width: 95%; /* or any smaller value you want */
    }

    .popup-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #343a40;
      color: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
      z-index: 9999;
      font-size: 18px;
      text-align: center;
      max-width: 400px;
    }

    .popup-modal .icon {
      font-size: 40px;
      display: block;
      margin-bottom: 15px;
      color: #ffa162;
    }

    .popup-modal button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    /* Calendly Modal Styles */
    .calendly-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    
    @media (max-width: 600px) {
      .popup-modal {
        width: 95vw;
        max-width: 700px;
        min-width: 0;
        /* min-height: 320px; */
        height: auto;
        padding: 40px 16px;
        border-radius: 8px;
        box-shadow: 0 5px 15px black;
        background: #343a40;
        color: white;
        font-size: 1.1rem;
        line-height: 1.5;
        margin: 0 auto;
      }

      .popup-modal .icon {
        font-size: 2rem;
        margin-bottom: 18px;
        display: block;
      }
    }

    .calendly-modal-content {
      background: #343a40;
      padding: 20px;
      border-radius: 8px;
      position: relative;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .calendly-modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    /* Calendly Modal */
    #calendlyModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #calendlyModal > .calendly-modal-content {
      background: #343a40;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }
    #calendlyModal .calendly-modal-close {
      position: absolute;
      top: 10px;
      right: 30px;
      background: none;
      border: none;
      font-size: 48px;
      color: #ff4800 !important;
      cursor: pointer;
      transition: color 0.2s;
    }
    #calendlyModal .calendly-modal-close:hover {
      color: red !important;
    }

  </style>
</head>
<body>
<header>
  <h1>Dashboard</h1>
  <nav id="sidebarLinksContainer">
    <a href="#editInfo">Edit Info</a>
    <a href="#bookSessions">Schedule Sessions</a>
    <a href="javascript:void(0)" id="sidebarLogoutBtn" class="text-danger px-3 py-2 text-decoration-none">Logout</a>
  </nav>
  <button id="profileBtn" class="btn btn-outline-light" style="display:none;">
    <i class="bx bx-user"></i>
  </button>
</header>

<div id="profileSidebar" class="sidebar bg-dark text-white" style="display:none;">
  <button class="btn btn-sm btn-outline-light ms-2 mt-2 close-btn" onclick="toggleSidebar()">× Close</button>
  <div class="mt-4 d-flex flex-column">
    <a style="margin-top: 20px;" href="#editInfo"> Edit Info </a>
    <a href="#bookSessions"> Schedule Sessions </a>
    <a href="javascript:void(0)" id="logoutBtn" class="text-danger px-3 py-2 text-decoration-none"> Logout </a>
  </div>
</div>

<div id="globalBackBtn" class="back-btn" onclick="handleBackClick()">
  <i class="fas fa-arrow-left">Home</i>
</div>

<!-- Edit Personal Info -->
<section id="editInfo" style="margin-top: 25px;">
  <h1>Personal Info for Booking</h1>
  <p style="text-align:center; max-width:600px; margin:0 auto 30px auto; color:#fff; font-size:.9rem; text-shadow:0 2px 8px #000;">
    Please ensure your information is accurate to avoid booking issues. <br>
    You can update this info anytime.
  </p>
  <form id="athleteForm">
    <label for="athleteName">Name</label>
    <input type="text" id="athleteName" name="athleteName" required />
    <div class="field-error" id="nameError"></div>

    <label for="email">Email</label>
    <input
      type="email"
      id="email"
      name="email"
      value=""
      readonly
      class="locked-input"
      required
      pattern="^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$"
      placeholder="Enter your email"
      oninvalid="this.setCustomValidity('Please enter a valid email address.')"
      oninput="this.setCustomValidity('')"
    />
    <div class="field-error" id="emailError"></div>

    <label for="phone">Phone</label>
    <input
      type="tel"
      id="phone"
      name="phone"
      required
      pattern="^\d{10,15}$"
      inputmode="tel"
      maxlength="15"
      placeholder="Enter phone number (digits only)"
      oninvalid="this.setCustomValidity('Please enter a valid phone number (digits only, 10-15 digits).')"
      oninput="this.setCustomValidity('')"
    />
    <div class="field-error" id="phoneError"></div> 

    <label for="dob">Date of Birth</label>
    <input type="date" id="dob" name="dob" required />
  
    <label for="sport">Level of Activity Daily</label>
    <select id="sport" name="sport" required>
      <option value="" selected>--</option>
      <option value="Highly Active">Highly Active</option>
      <option value="Moderately Active">Moderately Active</option>
      <option value="Not Active">Not Active</option>
    </select>

    <button type="submit">Save Info</button>
  </form>
</section>

<!-- Schedule Sessions (PAID PACKAGES ONLY) -->
<section id="bookSessions" style="margin-top: 55px; margin-bottom: 55px;">
  <h1>Schedule Your Sessions</h1>
  <div id="packageBookingContainer" class="athlete-box-container"></div>
  <div style="text-align:center; margin-top: 30px;">
    <button
      class="booking-btn"
      onclick="window.location.href='/packages'"
      style="font-size:1.2rem; padding:12px 32px; border-radius:8px; margin-top:10px;"
    >
      Explore Packages
    </button>
  </div>
</section>

<!-- Calendly Modal Overlay -->
<div id="calendlyModal" class="calendly-modal-overlay">
  <div class="calendly-modal-content">
    <button onclick="closeCalendly()" class="calendly-modal-close" aria-label="Close">&times;</button>
    <div id="calendlyInline" style="min-width:320px; height:500px;"></div>
  </div>
</div>

<div id="globalPopup" class="popup-modal">
  <span id="globalPopupIcon" class="icon"></span>
  <span id="globalPopupMessage"></span>
  <br>
  <button onclick="closeGlobalPopup()">OK</button>
</div>

<div id="emailEditPopup" class="popup-modal">
  <span class="icon">&#9888;</span>
  <span id="emailEditPopupMessage">
    Your email is used both to log in and to receive notifications.<br>
    Changing it will update both.<br><br>
    Continue?
  </span>
  <br>
  <button id="emailEditConfirmBtn">Yes, Edit Email</button>
  <button id="emailEditCancelBtn" style="margin-left:10px;">Cancel</button>
</div>

<script src="authStatus.js"></script>
<script src="https://assets.calendly.com/assets/external/widget.js" async></script>
<script>

  (async function checkRole() {
    const res = await fetch(`${API_BASE}/auth/me`, {
      credentials: 'include'
    });
    const data = await res.json();
    if (!data.user || data.user.role !== 'adult-athlete') {
      showGlobalPopup('Not authorized for Adult Athlete Dashboard');
      setTimeout(() => { window.location.href = "/login"; }, 1800);
    }
  })();

  function handleBackClick() {
     window.location.href = "/";
  }

  let userId = null;
  let customerId = null;
  let athleteId = null;
  let customerData = {};

  document.getElementById('athleteForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const fullName = document.getElementById("athleteName").value.trim();
    const [first_name, ...lastNameParts] = fullName.split(' ');
    const last_name = lastNameParts.join(' ') || '';
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const dob = document.getElementById("dob").value;
    const sport = document.getElementById("sport").value;

    const phoneRegex = /^\d{10,15}$/;
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    if (!phoneRegex.test(phone)) {
      showGlobalPopup("Please enter a valid phone number (digits only, 10-15 digits).");
      return;
    }
    if (!emailRegex.test(email)) {
      showGlobalPopup("Please enter a valid email address.");
      return;
    }

    // Make sure we have userId first
    if (!userId) {
      await fetchLoggedInUser();
    }

    const method = customerId ? 'PUT' : 'POST';
    const url = customerId
      ? `${API_BASE}/athlete/adult-athlete/update/${customerId}`
      : `${API_BASE}/athlete/adult-athlete/create`;

    try {
      const response = await fetch(url, {
        method,
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          first_name,
          last_name,
          dob,
          email,
          phone,
          sport,
          user_id: userId
        }),
      });

      const data = await response.json();
      if (response.ok) {
        const saveBtn = document.querySelector('button[type="submit"]');
        if (saveBtn) {
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Saved!';
          saveBtn.disabled = true;
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }, 2000);
        }
        customerId = data.customer?.id || data.customer?.customer_id || customerId;
        athleteId = data.athlete?.id || data.athlete?.athlete_id || athleteId;

        // New email handling logic
        if (emailField && emailField.classList.contains('editing')) {
          emailField.setAttribute('readonly', true);
          emailField.classList.remove('editing');
          emailField.classList.add('locked-input');
        }

        console.log("Saved adult athlete:", { customerId, athleteId });
      } else {
        showGlobalPopup(data.error || 'Error saving info.');
        return;
      }
    } catch (error) {
      console.error('Fetch error:', error);
      showGlobalPopup('Something went wrong saving athlete info!');
    }
  });

  // Fetch logged-in user
  async function fetchLoggedInUser() {
    try {
      const res = await fetch(`${API_BASE}/auth/me`, {
        credentials: 'include', // try sending cookie
      });
      const data = await res.json();
      if (data.user && data.user.id) {
        userId = data.user.id;
      } else {
        throw new Error('User data not found');
      }
    } catch (error) {
      showGlobalPopup('Session expired or unauthorized. Please log in again.');
      setTimeout(() => { window.location.href = "/login"; }, 1800);
    }
  }

  // Load athlete info
  async function loadCustomerData() {
    await fetchLoggedInUser();

    try {
      const athleteRes = await fetch(`${API_BASE}/athlete/adult-athlete/by-user/${userId}`, {
        credentials: 'include'
      });
      const athlete = await athleteRes.json();

      // ✅ Store both IDs
      customerId = athlete.customer?.id || athlete.customer_id;
      athleteId = athlete.athlete?.id || athlete.athlete_id;

      customerData = {
        first_name: athlete.customer?.first_name || "",
        last_name: athlete.customer?.last_name || "",
        email: athlete.customer?.email || ""
      };

      // Populate form fields
      document.getElementById("athleteName").value =
        ((athlete.customer?.first_name || "") + (athlete.customer?.last_name ? " " + athlete.customer.last_name : "")).trim();
      document.getElementById("email").value = athlete.customer?.email || "";
      document.getElementById("phone").value = athlete.customer?.phone || "";
      const dob = athlete.customer?.dob ? athlete.customer.dob.split('T')[0] : "";
      document.getElementById("dob").value = dob;

      const sportMap = {
        "highly active": "Highly Active",
        "moderately active": "Moderately Active",
        "moderatly active": "Moderately Active",
        "not active": "Not Active"
      };
      const sportValue = sportMap[(athlete.athlete?.sport || "").toLowerCase().trim()] || "";
      document.getElementById("sport").value = sportValue;
    } catch (error) {
      console.error('Error loading client data:', error);
    }
  }

  function toggleSidebar() {
    const sidebar = document.getElementById("profileSidebar");
    sidebar.style.display = sidebar.style.display === "block" ? "none" : "block";
  }

  document.getElementById("profileBtn").onclick = toggleSidebar;

  // Hide sidebar when clicking outside
  document.addEventListener("click", function (event) {
    const sidebar = document.getElementById("profileSidebar");
    const profileBtn = document.getElementById("profileBtn");
    if (
      sidebar.style.display === "block" &&
      !sidebar.contains(event.target) &&
      !(profileBtn && profileBtn.contains(event.target))
    ) {
      sidebar.style.display = "none";
    }
  });

  async function handleLogout() {
    try {      
      // Hit your logout route to clear the cookie
      fetch(`${API_BASE}/auth/logout`, {
        method: 'POST',
        credentials: 'include'
      });
    } catch (err) {
      console.error("Logout request failed:", err);
    }

    // Clear frontend tokens
    sessionStorage.clear();

    // Redirect to homepage
    window.location.href = "/";
  }

  // Load paid packages for booking
  async function loadPaidPackages() {
    if (!customerId) {
      const container = document.getElementById('packageBookingContainer');
      container.innerHTML = `
        <div class="athlete-box">
          Please complete your profile before booking.<br>
          Go to <strong>Personal Info</strong> above.
        </div>
      `;
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/athlete/paid-packages/${customerId}`, { credentials: 'include' });
      const packages = await res.json();

      const container = document.getElementById('packageBookingContainer');
      container.innerHTML = '';

      if (packages.length > 0) {
        const infoP = document.createElement('p');
        infoP.style.textAlign = "center";
        infoP.style.maxWidth = "550px";
        infoP.style.margin = "0 auto 24px auto";
        infoP.style.color = "#fff";
        infoP.style.fontSize = ".9rem";
        infoP.style.textShadow = "0 2px 8px #000";
        infoP.innerHTML = `Select<strong> "Click to Schedule"</strong> on your package. Calendly will open choose your timeslot and confirm. <br><br>Need more sessions? Click <strong>"Explore Packages"</strong> below.`;
        container.parentNode.insertBefore(infoP, container);
      } else {
        // Remove the instructional text if present
        const prev = container.previousElementSibling;
        if (prev && prev.tagName === "P" && prev.innerHTML.includes("Click to Schedule")) {
          prev.remove();
        }
        // Show the "no packages" box
        container.innerHTML = `
          <div class="athlete-box">
            <strong>No packages found.</strong><br>Click "Explore Packages" to purchase a package and schedule sessions.
          </div>
        `;
      }

      packages.forEach(pkg => {
        const box = document.createElement('div');
        box.className = 'athlete-box';

        box.innerHTML = `
          <h3>${pkg.name}</h3>
          <p>Package Sessions: ${pkg.sessions_remaining ?? 'N/A'}</p>
          <button class="book-calendly-btn" onclick="openCalendly('${pkg.calendly_url}')">
            Click to Schedule
          </button>
        `;
        container.appendChild(box);
      });
    } catch (err) {
      console.error('Error loading paid packages:', err);
      document.getElementById('packageBookingContainer').innerHTML = '<p>Error loading packages.</p>';
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadCustomerData();
    await loadPaidPackages();

    document.getElementById("logoutBtn")?.addEventListener("click", function(e) {
      e.preventDefault();
      handleLogout();
    });
    document.getElementById("sidebarLogoutBtn")?.addEventListener("click", function(e) {
      e.preventDefault();
      handleLogout();
    });

    // Show first login popup if needed (NOW customerData is ready)
    const isFirstLogin = sessionStorage.getItem("isFirstLogin");
    if (isFirstLogin === "true") {
      let firstName = customerData && customerData.first_name ? customerData.first_name : "";
      document.getElementById("firstLoginName").textContent = firstName;
      document.getElementById("firstLoginPopup").style.display = "block";
      sessionStorage.removeItem("isFirstLogin");
    }
  });

  async function autofillAthleteInfoIfFirstLogin() {
    if (localStorage.getItem("athleteAutofilled") === "true") {
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/athlete/me`, {
        method: 'GET',
        credentials: 'include'
      });
      if (!res.ok) return;
      const data = await res.json();
      const nameInput = document.getElementById("athleteName");
      const emailInput = document.getElementById("email");
      if (nameInput && !nameInput.value) {
        nameInput.value = `${data.first_name || ""} ${data.last_name || ""}`.trim();
      }
      if (emailInput && !emailInput.value) {
        emailInput.value = data.email || "";
      }
      localStorage.setItem("athleteAutofilled", "true");
    } catch (err) {
      console.error("Failed to autofill athlete info", err);
    }
  }

  async function autofillParentInfoIfFirstLogin() {
    if (localStorage.getItem("parentAutofilled") === "true") {
      console.log("Autofill skipped: already done");
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/athlete/me`, {
        method: 'GET',
        credentials: 'include'
      });
      if (!res.ok) {
        console.log("Autofill: /athlete/me not ok", res.status);
        return;
      }
      const data = await res.json();
      console.log("Autofill data:", data);
      const nameInput = document.getElementById("name");
      const emailInput = document.getElementById("email");
      if (nameInput && !nameInput.value) {
        nameInput.value = `${data.first_name || ""} ${data.last_name || ""}`.trim();
      }
      if (emailInput && !emailInput.value) {
        emailInput.value = data.email || "";
      }
      localStorage.setItem("parentAutofilled", "true");
    } catch (err) {
      console.error("Failed to autofill parent info", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    autofillAthleteInfoIfFirstLogin();
  });

  document.addEventListener("DOMContentLoaded", function() {
    if (window.location.hash === "#bookSessions") {
      setTimeout(() => {
        const el = document.getElementById("bookSessions");
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "start" });
          // Optionally scroll a bit more:
          setTimeout(() => window.scrollBy(0, 100), 400); // scroll 100px lower
        }
      }, 300);
    }
  });

  function closeGlobalPopup() {
    document.getElementById("globalPopup").style.display = "none";
  }

  // Show global popup with message
  function showGlobalPopup(message) {
    const iconSpan = document.getElementById('globalPopupIcon');
    // Show icon only for error/warning messages
    if (
      message.toLowerCase().includes('error') ||
      message.toLowerCase().includes('failed') ||
      message.toLowerCase().includes('not authorized') ||
      message.toLowerCase().includes('unauthorized') ||
      message.toLowerCase().includes('delete')
    ) {
      iconSpan.innerHTML = '&#9888;'; // ⚠
      iconSpan.style.display = 'inline';
    } else {
      iconSpan.innerHTML = '';
      iconSpan.style.display = 'none';
    }
    document.getElementById('globalPopupMessage').innerText = message;
    document.getElementById('globalPopup').style.display = 'block';
  }

  function openCalendly(url) {
    const name = (customerData.first_name || "") + (customerData.last_name ? " " + customerData.last_name : "");
    const email = customerData.email || "";

    // Determine if we need ? or &
    const joinChar = url.includes('?') ? '&' : '?';

    Calendly.initInlineWidget({
      url: url +
        joinChar +
        `hide_gdpr_banner=1` +
        `&background_color=343a40` +
        `&text_color=ffffff` +
        `&primary_color=ff4800` +
        `&name=${encodeURIComponent(name)}` +
        `&email=${encodeURIComponent(email)}`,
      parentElement: document.getElementById("calendlyInline"),
      prefill: {
        name: name,
        email: email,
      },
    });

    document.getElementById("calendlyModal").style.display = "flex";

    // Listen for event scheduled
    function calendlyListener(e) {
      if (e.data.event && e.data.event.indexOf("calendly.event_scheduled") === 0) {
        closeCalendly();
        showGlobalPopup("Your session has been scheduled! Confirmation sent to your email. \n\nNote: Your package sessions will decrease after you attend.");
        window.removeEventListener("message", calendlyListener);
      }
    }
    window.addEventListener("message", calendlyListener);
  }

  function closeCalendly() {
    document.getElementById("calendlyModal").style.display = "none";
    document.getElementById("calendlyInline").innerHTML = ""; // reset for next time
  }

  // Show first login popup if flagged in sessionStorage
  // document.addEventListener("DOMContentLoaded", function() {
  //   const isFirstLogin = sessionStorage.getItem("isFirstLogin");
  //   if (isFirstLogin === "true") {
  //     // Use the globally loaded customerData if available
  //     let firstName = "";
  //     if (customerData && customerData.first_name) {
  //       firstName = customerData.first_name;
  //     }
  //     document.getElementById("firstLoginName").textContent = firstName;
  //     document.getElementById("firstLoginPopup").style.display = "block";
  //     sessionStorage.removeItem("isFirstLogin"); // Prevent future triggers
  //   }
  // });

  function closeFirstLoginPopup() {
    document.getElementById("firstLoginPopup").style.display = "none";
  }

  const emailField = document.getElementById('email');
  const emailEditPopup = document.getElementById('emailEditPopup');
  const emailEditConfirmBtn = document.getElementById('emailEditConfirmBtn');
  const emailEditCancelBtn = document.getElementById('emailEditCancelBtn');

  emailField.addEventListener('click', () => {
    if (emailField.hasAttribute('readonly')) {
      emailEditPopup.style.display = 'block';
    }
  });
  emailEditConfirmBtn.onclick = function() {
    emailEditPopup.style.display = 'none';
    emailField.removeAttribute('readonly');
    emailField.classList.remove('locked-input');
    emailField.classList.add('editing');
    emailField.focus();
  };
  emailEditCancelBtn.onclick = function() {
    emailEditPopup.style.display = 'none';
  };
</script>

<div id="firstLoginPopup" style="
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #343a40;
  color: white;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.4);
  z-index: 9999;
  font-size: 18px;
  text-align: center;
  max-width: 400px;
">
  <p id="firstLoginMessage">
    Welcome, <span id="firstLoginName" style="color:#ff4800; font-weight:bold;"></span>! Please complete your profile before exploring packages.
  </p>
  <button onclick="closeFirstLoginPopup()" style="
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #ff4800;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  ">OK</button>
</div>

</body>
</html>
