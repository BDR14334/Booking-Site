<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <!-- Poppins & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <!-- Cropper.js CSS -->
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <style>
    .profile-dropdown {
      position: relative;
    }

    #mainContent {
      margin-left: 0;
      padding: 16px;
    }

    /* --- Mobile UX upgrades --- */

    /* Sidebar (offcanvas) link styling + dots */
    #adminOffcanvas .offcanvas-body a[data-section] {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
    }

    #adminOffcanvas .offcanvas-body a[data-section]::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.35);
      flex: 0 0 auto;
    }

    #adminOffcanvas .offcanvas-body a[data-section]:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    #adminOffcanvas .offcanvas-body a[data-section].active {
      background: rgba(255, 72, 0, 0.18);
    }

    #adminOffcanvas .offcanvas-body a[data-section].active::before {
      background: #ff4800;
      box-shadow: 0 0 0 2px rgba(255, 72, 0, 0.25);
    }

    /* Mobile-only: make offcanvas full-screen (<500px) */
    @media (max-width: 499.98px) {
      #adminOffcanvas.offcanvas {
        width: 100vw !important;
      }

      #adminOffcanvas .offcanvas-header {
        padding: 16px 16px;
      }

      #adminOffcanvas .offcanvas-title {
        font-size: 1.25rem;
      }

      #adminOffcanvas .offcanvas-body a[data-section] {
        font-size: 1.1rem;
        padding: 14px 12px;
      }
    }

    @media (max-width: 768px) {
      button,
      .btn,
      .dropdown-btn,
      .dropdown-menu .dropdown-item {
        min-height: 44px;
      }

      input,
      textarea,
      select {
        min-height: 44px;
        font-size: 16px;
      }

      #stripe-section #transactionSearchInput,
      #activeUsersSection #activeUserSearchInput {
        width: 100% !important;
        max-width: none !important;
      }
    }

    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    form label {
      display: block;
      margin: 10px 0 5px;
    }

    form input, form textarea {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
    }

    button {
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Athlete Box Styles */
    .package-box-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .package-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 700px;
      box-sizing: border-box;
      color: white;
    }

    .package-box input[name="athleteName"] {
      width: 95%; /* or any smaller value you want */
    }

    .add-package-box {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 300px;
      height: 500px;
      border: 2px dashed #ff4800;
      border-radius: 12px;
      font-size: 200px;
      font-weight: 50px;
      color: #ff4800;
      cursor: pointer;
      background-color: transparent;
    }

    .add-package-box:hover{
      background-color: #ff4800;
      color: #2a2f36;
    }

    /* Coach Assignment Box Styling */
    .assign-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      color: white;
      box-sizing: border-box;
      margin-bottom: 20px;
    }

    .package-selectable {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }

    .package-tag {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 5px 0;
      cursor: pointer;
    }
    .package-tag span:last-child {
      margin-left: 8px;
    }

    .package-tag.selected {
      background-color: #4caf50;
      color: white;
      border-color: #4caf50;
    }

    /* Optional: layout similar to .package-box-container */
    #coachAssignmentsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }


    select[multiple] {
      height: 100px;
      width: 100%;
    }

    .story-box-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .story-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 340px;
      box-sizing: border-box;
      color: white;
    }

    .add-story-box {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 340px; 
      border: 2px dashed #ff4800;
      border-radius: 12px;
      font-size: 100px;
      font-weight: bold;
      color: #ff4800;
      cursor: pointer;
      background-color: transparent;
    }

    .add-story-box:hover {
      background-color: #ff4800;
      color: #2a2f36;
    }

    .delete-story-btn {
      position: absolute;
      top: -5px;
      right: -12.5px;
      background: none;
      border: none;
      font-size: 30px;
      color: #ff4800;
      cursor: pointer;
    }

    .delete-story-btn:hover {
      color: red;
    }

    .choose-image-btn {
      background: #f5f5f5;
      color: #222;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.95rem;
      height: 32px;
      line-height: 1.2;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 1px 1px 2px #0001;
    }

    .choose-image-btn:hover {
      background: #eee;
      color: #ff4800;
      border-color: #ff4800;
    }

    .image-upload-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px; /* Add this line for spacing */
    }

    .package-section {
      margin-bottom: 10px;
    }

    .dropdown-btn {
      width: 100%;
      text-align: left;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background: #2a2f36;
      border: none;
      outline: none;
      border-radius: 6px 6px 0 0;
      font-weight: 600;
    }

    .dropdown-btn:hover {
      background: #ff4800;
      color: white;
    }

    /* Prevent orange hover for .no-hover dropdown-btn */
    .dropdown-btn.no-hover:hover,
    .dropdown-btn.no-hover:focus {
      background: #2a2f36 !important;
      color: inherit !important;
    }

    .dropdown-content {
      display: none;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      border-top: none;
      background: #2a2f36;
      border-radius: 0 0 6px 6px;
    }

    /* Dark dropdown background, white table/card */
    .dropdown-content .table {
      margin-bottom: 0;
      background: #fff;
      color: #111;
    }

    .dropdown-content .table th,
    .dropdown-content .table td {
      background: #fff;
      color: #111;
      border-color: #ddd;
    }

    .dropdown-content p {
      color: rgba(255,255,255,0.9);
    }

    .dropdown-content.show {
      display: block;
    }

    .athlete-bubble {
      display: inline-block;
      background: #ff4800;
      color: #fff;
      font-size: 0.95rem;
      font-weight: bold;
      border-radius: 50%;
      padding: 4px 10px;
      margin-left: 10px;
      position: absolute;
      top: 8px;
      right: 18px;
      z-index: 2;
      box-shadow: 0 2px 6px #2222;
    }
    .dropdown-btn {
      position: relative;
    }

    /* --- Mobile-friendly Athlete Package Usage (Admin) --- */
    #athlete-packages .package-section {
      margin-bottom: 14px;
    }

    /* Make header + search wrap nicely on small screens */
    #athlete-packages .athlete-packages-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    #athlete-packages .athlete-packages-header h2 {
      margin: 0;
    }

    #athlete-packages #athleteSearchInput {
      max-width: 420px;
      width: 260px;
    }

    /* Use non-overlapping bubble layout inside this section */
    #athlete-packages .dropdown-btn {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      white-space: normal;
    }

    #athlete-packages .athlete-bubble {
      position: static;
      margin-left: auto;
    }

    /* Bigger touch targets for +/- buttons */
    #athlete-packages .session-adjust-btn {
      min-width: 44px;
      min-height: 44px;
      padding: 8px 12px;
      font-size: 18px;
      line-height: 1;
      font-weight: 700;
    }

    #athlete-packages .session-actions {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
    }

    /* Stacked "card" rows on mobile */
    @media (max-width: 768px) {
      #athlete-packages #athleteSearchInput {
        width: 100% !important;
        max-width: none;
      }

      #athlete-packages .dropdown-content {
        padding: 10px 8px;
      }

      #athlete-packages table.table {
        border: 0;
        margin-bottom: 0;
      }

      #athlete-packages table.table thead {
        display: none;
      }

      #athlete-packages table.table,
      #athlete-packages table.table tbody,
      #athlete-packages table.table tr,
      #athlete-packages table.table td {
        display: block;
        width: 100%;
      }

      /* Let the dark dropdown background show between cards */
      #athlete-packages table.table,
      #athlete-packages table.table tbody {
        background: transparent;
      }

      #athlete-packages table.table tr {
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin: 12px 0;
        background: #fff;
      }

      #athlete-packages table.table td {
        border: 0;
        border-bottom: 1px solid #eee;
        background: #fff;
        color: #111;
        padding: 10px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      #athlete-packages table.table td:last-child {
        border-bottom: 0;
      }

      #athlete-packages table.table td::before {
        content: attr(data-label);
        font-weight: 700;
        color: #555;
        flex: 0 0 auto;
      }

      #athlete-packages table.table td[data-label="Actions"]::before {
        content: "";
        display: none;
      }
    }

    /* Mobile stacked tables for Stripe + Active Users */
    @media (max-width: 768px) {
      #stripe-section table.table,
      #activeUsersSection table.table {
        border: 0;
        margin-bottom: 0;
      }

      #stripe-section table.table thead,
      #activeUsersSection table.table thead {
        display: none;
      }

      #stripe-section table.table,
      #stripe-section table.table tbody,
      #stripe-section table.table tr,
      #stripe-section table.table td,
      #activeUsersSection table.table,
      #activeUsersSection table.table tbody,
      #activeUsersSection table.table tr,
      #activeUsersSection table.table td {
        display: block;
        width: 100%;
      }

      /* Let the dark dropdown background show between cards */
      #stripe-section table.table,
      #stripe-section table.table tbody,
      #activeUsersSection table.table,
      #activeUsersSection table.table tbody {
        background: transparent;
      }

      #stripe-section table.table tr,
      #activeUsersSection table.table tr {
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin: 12px 0;
        background: #fff;
      }

      #stripe-section table.table td,
      #activeUsersSection table.table td {
        border: 0;
        border-bottom: 1px solid #eee;
        background: #fff;
        color: #111;
        padding: 10px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      #stripe-section table.table td:last-child,
      #activeUsersSection table.table td:last-child {
        border-bottom: 0;
      }

      #stripe-section table.table td::before,
      #activeUsersSection table.table td::before {
        content: attr(data-label);
        font-weight: 700;
        color: #555;
        flex: 0 0 auto;
      }
    }

    .drag-handle {
      position: absolute;
      top: 8px;
      left: 10px;
      width: 16px;
      height: 22px;
      cursor: grab;
      z-index: 2;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      /* Add a background if you want extra contrast: */
      /* background: rgba(42,47,54,0.95); */
    }
    .drag-handle .dots {
      display: grid;
      grid-template-columns: repeat(2, 6px);
      grid-template-rows: repeat(3, 6px);
      gap: 3px 4px;
    }
    .drag-handle .dots span {
      display: block;
      width: 6px;
      height: 6px;
      background: #aaa;
      border-radius: 50%;
    }
    .package-box, .story-box {
      position: relative;
      padding-top: 24px;
      padding-left: 32px; /* Increase this value for more space */
      padding-right: 32px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark px-3" style="z-index: 1000; ">
    <a class="navbar-brand" href="#">Admin Panel</a>
   
    <!-- Profile Dropdown -->
    <div class="dropdown profile-dropdown">
      <button class="btn btn-outline-light dropdown-toggle" id="profileBtn" data-bs-toggle="dropdown">
        Menu
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li>
          <a class="dropdown-item" href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#adminOffcanvas">
            Admin Menu
          </a>
        </li>
        <li><a class="dropdown-item" href="/" id="toggleSite">Website</a></li>
        <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="logout()">Logout</a></li>
      </ul>
    </div>
  </nav>


  <!-- Offcanvas Sidebar -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="adminOffcanvas" aria-labelledby="adminOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="adminOffcanvasLabel">Admin Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body">
      <a class="d-block py-2 text-white text-decoration-none" href="javascript:void(0)" data-section="dashboard">üè† Dashboard</a>
      <a class="d-block py-2 text-white text-decoration-none" href="javascript:void(0)" data-section="coachRegistry">üìã Coach Registry</a>
      <a class="d-block py-2 text-white text-decoration-none" href="javascript:void(0)" data-section="addPackages">üì¶ Add Packages</a>
      <a class="d-block py-2 text-white text-decoration-none" href="javascript:void(0)" data-section="activeUsersSection">üü¢ Active Users</a>
      <a class="d-block py-2 text-white text-decoration-none" href="javascript:void(0)" data-section="athlete-packages">üéüÔ∏è Athletes To Packages</a>
      <a class="d-block py-2 text-white text-decoration-none" href="javascript:void(0)" data-section="stripe-section">üí≥ Stripe Payments</a>
      <a class="d-block py-2 text-white text-decoration-none" href="javascript:void(0)" data-section="manageStories">üèÖ Manage Success Stories</a>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <section id="dashboard" class="page-section">
      <h1>Welcome, Admin</h1>
      <p>This is your dashboard. Use the menu to navigate through admin functions like coach registry, adding packages, and assigning coaches.</p>
    </section>


    <section id="coachRegistry" class="page-section">
      <h2>Coach Registry</h2>
      <p>Here you can manage and view all registered coaches.</p>
      <div id="pendingCoachesContainer">
        <div class="pending-coaches-list"></div>
      </div>
      <div id="approvedCoachesContainer">
        <h4>Approved Coaches</h4>
        <div class="approved-coaches-list"></div>
      </div>
    </section>

    <section id="addPackages" class="page-section">
      <h2>Add Packages</h2>
      <p>Create new training or service packages for athletes and customers.</p>
      <div class="package-box-container">
        <!-- First Package Form -->
        <div class="package-box">
          <form class="packageInfoForm">
            <label for="packageTitle">Package Title</label>
            <input type="text" id="packageTitle" name="packageTitle" />

            <label for="description">Description</label>
            <div style="position: relative;">
              <textarea id="description" maxlength="400" rows="4" placeholder="Enter a short paragraph description..." style="padding-bottom: 28px;"></textarea>
              <span class="descCharCount" style="position: absolute; bottom: 6px; right: 10px; font-size: 0.95em; color: #aaa;">0/400 Characters</span>
            </div>
   
            <!-- Features list input -->
            <label for="features">Features</label>
            <div class="features-list">
              <div class="feature-item d-flex mb-2">
                <input type="text" class="form-control me-2" name="features[]" placeholder="Enter a feature..." />
                <button type="button" class="btn btn-danger btn-sm" onclick="removeFeature(this)">‚àí</button>
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFeature(this)">+ Add Feature</button>
            </div>
           
            <label for="sessionNumber">Number of Sessions</label>
            <input type="text" id="sessionNumber" name="sessionNumber" />


            <label for="price">Price</label>
            <input type="text" id="price" name="price" />

            <label >
              <input type="checkbox" name="isMemberPriced" id="isMemberPriced" style="margin-right: 8px; transform: scale(1.3); display: inline-flex; align-items: center; gap: 8px; width: fit-content;" ${pkg.is_member_priced ? 'checked' : ''} />
              Member Pricing
            </label>
           
            <!-- Calendly URL field -->
            <label for="calendlyUrl">Calendly URL</label>
            <input type="url" id="calendlyUrl" name="calendlyUrl" placeholder="https://calendly.com/your-link" />

            <button type="submit">Save Package</button>
          </form>
        </div>
   
        <!-- Add Package Button -->
        <div class="add-package-box" onclick="addPackageBox()">+</div>
      </div>
    </section>

    <section id="manageStories" class="page-section">
      <h2>Manage Success Stories</h2>
      <p>Click the add button to add athlete success stories to the homepage.</p>

      <div class="story-box-container">
        <div class="story-box">
          <button class="delete-story-btn material-symbols-outlined" onclick="this.closest('.story-box').remove()">close</button>
          <form class="storyForm" enctype="multipart/form-data" onsubmit="return false;">
            <label>Athlete Name</label>
            <input type="text" name="athleteName" required />

            <label>Success Story</label>
            <textarea name="storyText" rows="4" required></textarea>

            <label>Image</label>
            <div class="image-upload-wrapper" style="display: flex; align-items: center; gap: 10px;">
              <input type="file" name="athleteImage" accept="image/*" class="image-input" style="display:none;" />
              <img class="image-preview" src="img/placeholder.png" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ff4800;" />
              <button type="button" class="choose-image-btn" style="margin-left: 10px;">Choose Image</button>
            </div>

            <button type="submit">Save Story</button>
          </form>
        </div>
        <div class="add-story-box" onclick="addStoryBox()">+</div>
      </div>

      <div id="storyList" style="margin-top: 20px;"></div>
    </section>

    <section id="athlete-packages" class="page-section">
      <div class="athlete-packages-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
        <h2 style="margin: 0;">Manage Athlete Package Usage</h2>
        <input
          type="text"
          id="athleteSearchInput"
          class="form-control"
          style="width: 260px;"
          placeholder="Search athlete name..."
          oninput="filterAthletePackages()"
        />
      </div>
      <p>
        This section displays all athletes assigned to each package. The orange bubble next to each package name shows how many athletes have remaining sessions for that package.<br>
        Use the <span style="color:#ff4800;font-weight:bold;">‚Äì</span> button to subtract a session when an athlete attends, and the <span style="color:#28a745;font-weight:bold;">+</span> button to add sessions to an athlete if needed.
      </p>
      <div id="package-dropdowns"></div>
    </section>

    <section id="stripe-section" class="page-section">
      <h2>Stripe Account</h2>
      <p>Manage payments and view your Stripe dashboard.</p>
      <a href="https://dashboard.stripe.com/login" target="_blank" rel="noopener" class="btn btn-primary" style="font-size:1.2rem; padding:12px 32px; margin-top:20px;">
        Go to Stripe Dashboard
      </a>

      <!-- Add search bar here -->
      <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
        <input
          type="text"
          id="transactionSearchInput"
          class="form-control"
          style="width: 260px;"
          placeholder="Search Transaction or Receipt ID..."
          oninput="filterTransactions()"
        />
      </div>

      <!-- Recent Transactions styled like package-section -->
      <div class="package-section" style="margin-top:32px;">
        <button class="dropdown-btn no-hover" style="cursor:default;" disabled>
          Recent Transactions
        </button>
        <div class="dropdown-content show" style="display:block;">
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Transaction ID</th>
                    <th>Receipt ID</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="transactionList"></tbody>
              </table>
            </div>
        </div>
      </div>
    </section>

    <!-- Add this after your Stripe section or wherever you want it to appear -->
    <section id="activeUsersSection" class="page-section">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
        <h2 style="margin: 0;">Active Users</h2>
        <input
          type="text"
          id="activeUserSearchInput"
          class="form-control"
          style="width: 260px;"
          placeholder="Search name or email..."
          oninput="filterActiveUsers()"
        />
      </div>
      <div class="package-section" style="margin-top:0px;">
        <p>View currently active users on the platform. Assess if they are part of Chicagoland Zephyrs (Member).</p>
        <div id="activeUsersDropdowns"></div>
      </div>
    </section>

  </div>

  <script src="authStatus.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    // Use local backend if running locally, otherwise use deployed backend
    
    // Redirect to login if not authenticated

    function logout() {
      try {
        fetch(`${API_BASE}/auth/logout`, {
          method: 'POST',
          credentials: 'include',
        });
      } catch (err) {
        console.error("Logout request failed:", err);
      }
      sessionStorage.clear();
      window.location.href = "/";
    }

    document.addEventListener('DOMContentLoaded', async function () {
      // 1. Auth check
      try {
        const res = await fetch(`${API_BASE}/auth/verify`, {
          credentials: "include",
        });
        const data = await res.json();
        if (!res.ok || !data.loggedIn || data.user.role !== 'admin') {
          window.location.href = "/";
          return;
        }
      } catch (err) {
        console.error("Access check failed", err);
        window.location.href = "/";
        return;
      }

      // 2. Section switching (offcanvas)
      let currentSection = 'dashboard';

      function pushState(sectionId) {
        history.pushState({ sectionId }, '', '');
      }

      function setActiveNav(sectionId) {
        document.querySelectorAll('#adminOffcanvas [data-section]').forEach(link => {
          link.classList.toggle('active', link.getAttribute('data-section') === sectionId);
        });
      }

      function showSection(sectionId) {
        currentSection = sectionId;
        document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
        const target = document.getElementById(sectionId);
        if (target) {
          target.classList.add('active');
          if (sectionId === 'coachRegistry') {
            loadPendingCoaches();
            loadApprovedCoaches();
          }
          if (sectionId === 'manageStories') {
            loadStories();
          }
          if (sectionId === 'athlete-packages') {
            loadAthletePackages();
          }
        }
        setActiveNav(currentSection);
        pushState(currentSection);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      window.showSection = showSection;

      document.addEventListener('click', (e) => {
        const link = e.target.closest('[data-section]');
        if (!link) return;

        const sectionId = link.getAttribute('data-section');
        if (!sectionId) return;

        showSection(sectionId);

        const offcanvasEl = document.getElementById('adminOffcanvas');
        if (offcanvasEl && window.bootstrap) {
          try {
            const instance = bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl);
            instance.hide();
          } catch (err) {
            // Ignore if offcanvas isn't available/initialized
          }
        }
      });

      // Handle browser navigation
      window.addEventListener('popstate', function(event) {
        const state = event.state;
        if (state && state.sectionId) {
          showSection(state.sectionId);
        }
      });

      // Set initial state and show dashboard
      pushState(currentSection);
      showSection('dashboard');
    });

    // Accept Registered Coaches
    async function loadPendingCoaches() {
      try {
        const res = await fetch(`${API_BASE}/admin/pending-coaches`, {
          credentials: 'include'
        });

        const coaches = await res.json();
        const list = document.querySelector(".pending-coaches-list");
        list.innerHTML = '';

        console.log("Pending Coaches Response:", coaches); // Optional debug

        coaches.forEach(coach => {
          if (!coach.coach_id) {  // Coach not yet approved
            const card = document.createElement("div");
            card.className = "assign-box";
            card.innerHTML = `
              <h5>${coach.first_name} ${coach.last_name}</h5>
              <p>Email: ${coach.email}</p>
              <button onclick="approveCoach(${coach.user_id}, '${coach.email}')">Approve Coach</button>

            `;
            list.appendChild(card);
          }
        });
      } catch (err) {
        console.error("Failed to load pending coaches", err);
      }
    }

    async function approveCoach(coachId, email) {
      const coachCode = Math.floor(1000 + Math.random() * 9000); // 4-digit ID

      const res = await fetch(`${API_BASE}/admin/approve-coach`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ coachId, email, coachCode })
      });

      const result = await res.json();
      if (res.ok) {
        alert(`Coach approved. Login ID ${coachCode} sent to ${email}`);
        loadPendingCoaches(); // Refresh list
      } else {
        alert(result.error || "Approval failed.");
      }
    }

    async function loadApprovedCoaches() {
      try {
        const res = await fetch(`${API_BASE}/admin/approved-coaches`, {
          credentials: 'include'
        });
        const coaches = await res.json();
        const list = document.querySelector(".approved-coaches-list");
        list.innerHTML = '';

        coaches.forEach(coach => {
          const card = document.createElement("div");
          card.className = "assign-box";
          card.innerHTML = `
            <h5>${coach.first_name} ${coach.last_name}</h5>
            <p>Email: ${coach.email}</p>
            <p>Coach ID: ${coach.coach_id}</p>
            <button onclick="fireCoach(${coach.id})" class="btn btn-danger">Fire Coach</button>
          `;
          list.appendChild(card);
        });
      } catch (err) {
        console.error("Failed to load approved coaches", err);
      }
    }

    async function fireCoach(coachId) {
      if (!confirm("Are you sure you want to fire this coach?")) return;

      try {
        const res = await fetch(`${API_BASE}/admin/fire-coach/${coachId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const result = await res.json();
        if (res.ok) {
          alert("Coach successfully fired.");
          loadApprovedCoaches();
        } else {
          alert(result.error || "Failed to fire coach.");
        }
      } catch (err) {
        console.error("Error firing coach", err);
      }
    }


    // Add Package Section
    function addFeature(button) {
      const container = button.parentElement;
      const featureItem = document.createElement('div');
      featureItem.className = 'feature-item d-flex mb-2';
      featureItem.innerHTML = `
        <input type="text" class="form-control me-2" name="features[]" placeholder="Enter a feature..." />
        <button type="button" class="btn btn-danger btn-sm" onclick="removeFeature(this)">‚àí</button>
      `;
      container.insertBefore(featureItem, button);
    }
 
    function removeFeature(button) {
      const featureItem = button.parentElement;
      featureItem.remove();
    }

    document.addEventListener('input', function (e) {
      if (e.target.matches('textarea[name="description"]')) {
        const span = e.target.parentElement.querySelector('.descCharCount');
        if (span) {
          span.textContent = `${e.target.value.length}/400 Characters`;
        }
      }
    });
 
    function createPackageForm(pkg = {}) {
      const box = document.createElement('div');
      box.className = 'package-box';

      // Add drag handle at the top left
      box.innerHTML = `
        <div class="drag-handle" title="Drag to reorder">
          <span class="dots">
            <span></span><span></span>
            <span></span><span></span>
            <span></span><span></span>
          </span>
        </div>
      `;

      const form = document.createElement('form');
      form.className = 'packageInfoForm';

      const featuresArray = Array.isArray(pkg.features) ? pkg.features : [];

      const descValue = pkg.description || '';
      form.innerHTML = `
        <label for="packageTitle">Package Title</label>
        <input type="text" name="packageTitle" value="${pkg.title || ''}" />

        <label for="description">Description</label>
        <div style="position: relative;">
          <textarea id="description" name="description" maxlength="400" rows="4" placeholder="Enter a short paragraph description..." style="padding-bottom: 28px;">${descValue}</textarea>
          <span class="descCharCount" style="position: absolute; bottom: 0px; right: 10px; font-size: 0.95em; color: #aaa;">${descValue.length}/400 Characters</span>
        </div>

        <label for="features">Features</label>
        <div class="features-list">
          ${(featuresArray.length > 0 ? featuresArray : ['']).map(desc => `
            <div class="feature-item d-flex mb-2">
              <input type="text" class="form-control me-2" name="features[]" value="${desc}" placeholder="Enter a feature..." />
              <button type="button" class="btn btn-danger btn-sm" onclick="removeFeature(this)">‚àí</button>
            </div>
          `).join('')}
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFeature(this)">+ Add Feature</button>
        </div>

        <label for="sessionNumber">Number of Sessions</label>
        <input type="text" name="sessionNumber" value="${pkg.sessions || ''}" />

        <label for="price">Price</label>
        <input type="text" name="price" value="${pkg.price || ''}" />

        <label >
          <input type="checkbox" name="isMemberPriced" id="isMemberPriced" style="margin-right: 8px; transform: scale(1.3); display: inline-flex; align-items: center; gap: 8px; width: fit-content;" ${pkg.is_member_priced ? 'checked' : ''} />
          Member Pricing
        </label>

        <label for="calendlyUrl">Calendly URL</label>
        <input type="url" name="calendlyUrl" value="${pkg.calendlyUrl || ''}" placeholder="https://calendly.com/your-link" />

        <button type="submit">Save Package</button>
      `;
 
      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Prevent accidental double submits
        if (form.dataset.saving === '1') return;
        form.dataset.saving = '1';
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Saving...';
        }

        const formData = new FormData(form);
        const packageTitle = (formData.get('packageTitle') || '').toString().trim();
        const sessionNumber = (formData.get('sessionNumber') || '').toString().trim();
        const price = (formData.get('price') || '').toString().trim();
        const description = form.querySelector('textarea[name="description"]').value.trim();
        const features = formData.getAll('features[]').map(v => v.toString().trim()).filter(item => item !== '');
        const calendlyUrl = (formData.get('calendlyUrl') || '').toString().trim();
        const isMemberPriced = !!form.querySelector('input[name="isMemberPriced"]').checked;

        if (!description.length) {
          alert("Please enter a package description.");
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalBtnText; }
          form.dataset.saving = '0';
          return;
        }

        const payload = {
          packageTitle,
          sessionNumber,
          price,
          description,
          features,
          calendlyUrl,
          isMemberPriced
        };

        const method = pkg.id ? 'PUT' : 'POST';
        const endpoint = pkg.id
          ? `${API_BASE}/admin/update-package/${pkg.id}`
          : `${API_BASE}/admin/create-package`;

        try {
          const response = await fetch(endpoint, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });

          const result = await response.json();
          const returned = result && (result.package || result);

          if (response.ok) {
            alert('Package saved!');
            console.log('Save result:', result);

            // If this was a create (POST), switch this box to update mode using the new ID
            if (!pkg.id && returned && returned.id) {
              const updatedPkg = {
                id: returned.id,
                title: packageTitle,
                sessions: sessionNumber,
                price: price,
                description,
                features,
                calendlyUrl,
                is_member_priced: isMemberPriced
              };
              const newForm = createPackageForm(updatedPkg);
              box.replaceWith(newForm);
            }
          } else {
            const errMsg = (result && (result.error || result.message)) || 'Unknown error';
            alert('Failed to save package: ' + errMsg);
          }
        } catch (error) {
          console.error('Error submitting package:', error);
          alert('An error occurred. Check console for details.');
        } finally {
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalBtnText; }
          form.dataset.saving = '0';
        }
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-story-btn material-symbols-outlined'; // Use the same class as stories
      deleteBtn.type = 'button';
      deleteBtn.innerText = 'close'; // Material icon name

      if (pkg.id) {
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete this package?')) {
            try {
              const res = await fetch(`${API_BASE}/admin/delete-package/${pkg.id}`, {
                method: 'DELETE',
                credentials: 'include'
              });
              if (res.ok) {
                alert('Package deleted.');
                box.remove();
              } else {
                const result = await res.json();
                alert('Failed to delete package: ' + result.error);
              }
            } catch (err) {
              console.error('Error deleting package:', err);
              alert('An error occurred. Check console for details.');
            }
          }
        });
      } else {
        deleteBtn.addEventListener('click', () => box.remove());
      }

      box.appendChild(form);
      box.appendChild(deleteBtn);
      return box;
    }
 
    function addPackageBox() {
      const container = document.querySelector('.package-box-container');
      const addButton = document.querySelector('.add-package-box');
      const newBox = createPackageForm();
      container.insertBefore(newBox, addButton);
    }

    function enablePackageSorting() {
      const container = document.querySelector('.package-box-container');
      if (!container) return;
      Sortable.create(container, {
        animation: 150,
        handle: '.drag-handle', // Only allow dragging by the handle
        filter: '.add-package-box', // Prevent dragging the add button
        onEnd: function () {
          // Save the new order of package IDs to localStorage
          const order = Array.from(container.querySelectorAll('.packageInfoForm')).map(form => form.dataset.id);
          localStorage.setItem('packageOrder', JSON.stringify(order));
        }
      });
    }
 
    async function loadExistingPackages() {
      try {
        const response = await fetch(`${API_BASE}/admin/get-packages`, {
          credentials: 'include'
        });

        const packages = await response.json();
        if (response.ok) {
          const container = document.querySelector('.package-box-container');
          const addButton = document.querySelector('.add-package-box');
          container.innerHTML = '';

          // Get saved order from localStorage
          const savedOrder = JSON.parse(localStorage.getItem('packageOrder') || '[]');
          // Sort packages according to saved order
          const orderedPackages = savedOrder.length
            ? savedOrder
                .map(id => packages.find(pkg => String(pkg.id) === String(id)))
                .filter(Boolean)
                .concat(packages.filter(pkg => !savedOrder.includes(String(pkg.id))))
            : packages;

          orderedPackages.forEach(pkg => {
            const box = createPackageForm(pkg);
            // Make sure each form has a data-id for sorting
            box.querySelector('form').dataset.id = pkg.id;
            container.appendChild(box);
          });
          container.appendChild(addButton);

          enablePackageSorting(); // Enable drag-and-drop after rendering
        } else {
          alert('Failed to load packages: ' + packages.error);
        }
      } catch (err) {
        console.error('Error loading packages:', err);
      }
    }
 
    window.addEventListener('DOMContentLoaded', () => {
      loadExistingPackages();
    });


    // document.addEventListener('DOMContentLoaded', () => {
    //   if (document.getElementById("storyList")) loadStories();
    // });

    // Sort stories
    function enableStorySorting() {
      const container = document.querySelector('.story-box-container');
      if (!container) return;
      Sortable.create(container, {
        animation: 150,
        handle: '.drag-handle', // Only allow dragging by the handle (the dots)
        onEnd: async function () {
          const order = Array.from(container.querySelectorAll('.storyForm')).map(form => form.dataset.id);
          try {
            await fetch(`${API_BASE}/admin/reorder-stories`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ orderedIds: order })
            });
          } catch (err) {
            console.error('Failed to persist story order:', err);
          }
        }
      });
    }
    async function loadStories() {
      const res = await fetch(`${API_BASE}/admin/stories`);
      const stories = await res.json();

      const container = document.querySelector('.story-box-container');
      const addButton = document.querySelector(".add-story-box");
      container.innerHTML = ""; // Clear current story boxes
      // Stories already ordered by created_at DESC after reorder endpoint manipulates timestamps
      stories.forEach(story => {
        let imgSrc;
        if (story.image_url) {
          imgSrc = story.image_url.startsWith('http')
            ? story.image_url
            : `${API_BASE}${story.image_url}`;
        } else {
          imgSrc = 'img/placeholder.png';
        }

        const box = document.createElement("div");
        box.className = "story-box";
        box.innerHTML = `
          <div class="drag-handle" title="Drag to reorder">
            <span class="dots">
              <span></span><span></span>
              <span></span><span></span>
              <span></span><span></span>
            </span>
          </div>
          <button class="delete-story-btn material-symbols-outlined" onclick="deleteStory(${story.id}, this)">close</button>
          <form class="storyForm" data-id="${story.id}" enctype="multipart/form-data" onsubmit="return false;">
            <label>Athlete Name</label>
            <input type="text" name="athleteName" value="${story.name}" required />

            <label>Success Story</label>
            <textarea name="storyText" rows="4" required>${story.story}</textarea>

            <label>Image</label>
            <div class="image-upload-wrapper" style="display: flex; align-items: center; gap: 10px;">
              <input type="file" name="athleteImage" accept="image/*" class="image-input" style="display:none;" />
              <img class="image-preview" src="${imgSrc}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ff4800;" />
              <button type="button" class="choose-image-btn" style="margin-left: 10px;">Choose Image</button>
            </div>

            <button type="submit">Save Story</button>
          </form>
        `;
        box.querySelector("form").addEventListener("submit", handleStorySubmit);
        container.appendChild(box);
      });

      if (addButton) container.appendChild(addButton);
      enableStorySorting(); // Enable sorting after loading stories
    }

    function addStoryBox() {
      const container = document.querySelector('.story-box-container');
      const addButton = document.querySelector('.add-story-box');

      const box = document.createElement('div');
      box.className = 'story-box';
      box.innerHTML = `
        <button class="delete-story-btn material-symbols-outlined" onclick="this.closest('.story-box').remove()">close</button>
        <form class="storyForm" enctype="multipart/form-data" onsubmit="return false;">
          <label>Athlete Name</label>
          <input type="text" name="athleteName" required />

          <label>Success Story</label>
          <textarea name="storyText" rows="4" required></textarea>

          <label>Image</label>
          <div class="image-upload-wrapper" style="display: flex; align-items: center; gap: 10px;">
              <input type="file" name="athleteImage" accept="image/*" class="image-input" style="display:none;" />
              <img class="image-preview" src="img/placeholder.png" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ff4800;" />
              <button type="button" class="choose-image-btn" style="margin-left: 10px;">Choose Image</button>
            </div>

          <button type="submit">Save Story</button>
        </form>
      `;

      box.querySelector('form').addEventListener('submit', handleStorySubmit);
      container.insertBefore(box, addButton);
    }

    async function deleteStory(id, button) {
      if (!confirm("Are you sure you want to delete this story?")) return;

      try {
        const res = await fetch(`${API_BASE}/admin/delete-story/${id}`, {
          method: "DELETE"
        });

        if (res.ok) {
          alert("Story deleted.");
          button.closest(".story-box").remove();
        } else {
          const result = await res.json();
          alert(result.error || "Failed to delete.");
        }
      } catch (err) {
        console.error("Delete failed:", err);
        alert("Server error during delete.");
      }
    }

    async function handleStorySubmit(e) {
      e.preventDefault();
      const form = e.target;
      const storyId = form.dataset.id;

      const formData = new FormData();
      formData.append("athleteName", form.querySelector('[name="athleteName"]').value);
      formData.append("storyText", form.querySelector('[name="storyText"]').value);

      // Use the cropped blob for this form if it exists
      if (form.croppedBlob) {
        formData.append("athleteImage", form.croppedBlob, 'cropped.jpg');
      } else {
        const imageInput = form.querySelector('[name="athleteImage"]');
        if (imageInput && imageInput.files.length > 0) {
          formData.append("athleteImage", imageInput.files[0]);
        }
      }

      const url = storyId
        ? `${API_BASE}/admin/update-story/${storyId}`
        : `${API_BASE}/admin/add-story`;

      const method = storyId ? "PUT" : "POST";

      try {
        const res = await fetch(url, {
          method,
          body: formData
        });

        const result = await res.json();

        if (res.ok) {
          alert(storyId ? "Story updated!" : "Story added!");
          loadStories(); // Refresh UI
          showSection('manageStories'); // Ensure the section stays visible
        } else {
          alert(result.error || "Failed to save story.");
        }
      } catch (err) {
        console.error("Error submitting story:", err);
        alert("Error submitting story.");
      }
    }

    let cropper = null;
    let currentImageInput = null;
    let currentPreview = null;
    let currentForm = null;
    let croppedBlob = null;

    // Open crop modal when image is selected
    document.body.addEventListener('change', function(e) {
      if (e.target.classList.contains('image-input')) {
        const input = e.target;
        const file = input.files[0];
        if (!file) return;

        const form = input.closest('form');
        const preview = form.querySelector('.image-preview');
        const reader = new FileReader();

        if (window.location.hostname === "localhost") {
          // Local: open crop modal
          currentImageInput = input;
          currentForm = form;
          currentPreview = preview;
          reader.onload = function(evt) {
            const cropModal = document.getElementById('cropModal');
            const cropImage = document.getElementById('cropImage');
            cropImage.src = evt.target.result;
            cropModal.style.display = 'flex';

            if (cropper) cropper.destroy();
            cropper = new Cropper(cropImage, {
              aspectRatio: 1,
              viewMode: 1,
              autoCropArea: 1,
            });
          };
          reader.readAsDataURL(file);
        } else {
          // Production/Supabase: show direct preview
          reader.onload = function(evt) {
            preview.src = evt.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      }
    });

    document.addEventListener('DOMContentLoaded', function() { 
      // Confirm crop
      document.getElementById('confirmCropBtn').addEventListener('click', function() {
        if (cropper && currentPreview && currentForm) {
          cropper.getCroppedCanvas({
            width: 300,
            height: 300
          }).toBlob(blob => {
            // Store the cropped blob on the form
            currentForm.croppedBlob = blob;
            currentPreview.src = URL.createObjectURL(blob);
            currentPreview.style.display = 'block';
            document.getElementById('cropModal').style.display = 'none';
            cropper.destroy();
            cropper = null;
          }, 'image/jpeg');
        }
      });

      // Cancel crop
      document.getElementById('cancelCropBtn').addEventListener('click', function() {
        document.getElementById('cropModal').style.display = 'none';
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      });

    });

    
    // Allow clicking preview to replace image
    document.body.addEventListener('click', function(e) {
      // Click "Choose Image" button
      if (e.target.classList.contains('choose-image-btn')) {
        const form = e.target.closest('form');
        const input = form.querySelector('.image-input');
        if (input) {
          // Reset the input value so selecting the same file triggers 'change'
          input.value = '';
          input.click();
        }
      }
    });

    // When file is chosen, open crop modal
    document.body.addEventListener('change', function(e) {
      if (e.target.classList.contains('image-input')) {
        const input = e.target;
        const file = input.files[0];
        if (!file) return;

        currentImageInput = input;
        currentForm = input.closest('form');
        currentPreview = currentForm.querySelector('.image-preview');

        const reader = new FileReader();
        reader.onload = function(evt) {
          const cropModal = document.getElementById('cropModal');
          const cropImage = document.getElementById('cropImage');
          cropImage.src = evt.target.result;
          cropModal.style.display = 'flex';

          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
          });
        };
        reader.readAsDataURL(file);
      }
    });

    
  </script>

    <div id="deleteModal" style="display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
      <div style="background:white; padding:20px; max-width:400px; margin:15% auto; border-radius:8px; text-align:center;">
        <p style="color:#ff4800">Do you want to delete this timeslot or all future ones?</p>
        <button id="deleteOneBtn">Delete One</button>
        <button id="deleteAllBtn">Delete Future</button>
        <button id="cancelDeleteBtn">Cancel</button>
      </div> <!--Make the styling of most of like my log buttons like this popup-->
    </div>

    <!-- Crop Image Modal -->
    <div id="cropModal" style="display:none; position:fixed; z-index:2000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
      <div style="background:#222; padding:24px 24px 16px 24px; border-radius:12px; max-width:90vw; max-height:90vh; text-align:center; position:relative;">
        <img id="cropImage" style="max-width:70vw; max-height:60vh; background:#fff; border-radius:8px;" />
        <div style="margin-top:16px;">
          <button id="confirmCropBtn" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;">Confirm Crop</button>
          <button id="cancelCropBtn" style="padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer;">Cancel</button>
        </div>
      </div>
    </div>

<script>
  let openDropdowns = [];

  async function loadAthletePackages() {
    try {
      // Fetch all packages and all athlete usages
      const [packagesRes, usagesRes] = await Promise.all([
        fetch(`${API_BASE}/admin/all-packages`, { credentials: 'include' }),
        fetch(`${API_BASE}/admin/athlete-packages`, { credentials: 'include' })
      ]);
      allPackagesList = await packagesRes.json();
      allAthleteUsages = await usagesRes.json();

      renderAthletePackagesDropdowns();
    } catch (err) {
      console.error('Error loading athlete packages:', err);
    }
  }

  function renderAthletePackagesDropdowns(search = "") {
    // Group usages by package name
    const grouped = {};
    allAthleteUsages.forEach(pkg => {
      if (!grouped[pkg.package_name]) grouped[pkg.package_name] = [];
      grouped[pkg.package_name].push(pkg);
    });

    const container = document.getElementById('package-dropdowns');
    container.innerHTML = '';

    // Lowercase search for comparison
    const searchLower = search.trim().toLowerCase();

    allPackagesList.forEach(pkg => {
      const packageName = pkg.name;
      let athletes = grouped[packageName] || [];

      // Filter by search
      let filteredAthletes = athletes;
      if (searchLower) {
        filteredAthletes = athletes.filter(a =>
          a.athlete_name && a.athlete_name.toLowerCase().includes(searchLower)
        );
      }

      // Only show packages that have at least one matching athlete if searching
      if (searchLower && filteredAthletes.length === 0) {
        return; // Skip this package
      }

      // Sort: athletes with sessions_remaining > 0 first
      filteredAthletes.sort((a, b) => b.sessions_remaining - a.sessions_remaining);

      const wrapper = document.createElement('div');
      wrapper.classList.add('package-section');

      // Dropdown content (athlete list)
      const content = document.createElement('div');
      content.classList.add('dropdown-content');

      // Package header (clickable dropdown)
      const header = document.createElement('button');
      header.classList.add('dropdown-btn');

      // Count athletes with sessions_remaining > 0
      const activeCount = filteredAthletes.filter(a => a.sessions_remaining > 0).length;

      // Create the dropdown header with bubble
      header.innerHTML = `
        ${packageName}
        <span class="athlete-bubble">${activeCount}</span>
      `;

      // If searching, always open the dropdown for matching packages
      if (searchLower) {
        content.classList.add('show');
      }

      header.onclick = () => {
        content.classList.toggle('show');
        // Update openDropdowns after toggle
        if (content.classList.contains('show')) {
          if (!openDropdowns.includes(packageName)) openDropdowns.push(packageName);
        } else {
          openDropdowns = openDropdowns.filter(name => name !== packageName);
        }
      };

      // If this dropdown was open before, keep it open (unless searching)
      if (!searchLower && openDropdowns.includes(packageName)) {
        content.classList.add('show');
      }

      if (filteredAthletes.length === 0) {
        content.innerHTML = `<p>No athletes booked for this package.</p>`;
      } else {
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-responsive';

        const table = document.createElement('table');
        table.className = "table table-bordered table-sm";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Athlete</th>
              <th>Age</th>
              <th>Sport</th>
              <th>Sessions Purchased</th>
              <th>Sessions Remaining</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filteredAthletes.map(a => `
              <tr>
                <td data-label="Athlete">${a.athlete_name}</td>
                <td data-label="Age">${a.age ? a.age : (a.age_group || '')}</td>
                <td data-label="Sport">${a.sport || ''}</td>
                <td data-label="Sessions Purchased">${a.sessions_purchased}</td>
                <td data-label="Sessions Remaining">${a.sessions_remaining}</td>
                <td data-label="Actions">
                  <div class="session-actions">
                    <button type="button" class="btn btn-warning btn-sm session-adjust-btn" onclick="event.stopPropagation(); updateSession(${a.usage_id}, -1)">‚àí</button>
                    <button type="button" class="btn btn-success btn-sm session-adjust-btn" onclick="event.stopPropagation(); updateSession(${a.usage_id}, 1)">+</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        `;

        tableWrapper.appendChild(table);
        content.appendChild(tableWrapper);
      }

      wrapper.appendChild(header);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    });
  }

  function filterAthletePackages() {
    const search = document.getElementById('athleteSearchInput').value.trim().toLowerCase();
    renderAthletePackagesDropdowns(search);
  }

  // Update session count (subtract or add)
  async function updateSession(usageId, delta) {
    await fetch(`${API_BASE}/admin/athlete-packages/${usageId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ subtract: -delta }) // negative delta for add, positive for subtract
    });
    // Do not reset openDropdowns, just reload data
    loadAthletePackages();
  }
  window.updateSession = updateSession;

  let allTransactions = [];

  async function loadTransactions() {
    try {
      const res = await fetch(`${API_BASE}/admin/transactions`, { credentials: 'include' });
      allTransactions = await res.json();
      renderTransactions();
    } catch (err) {
      console.error('Failed to load transactions', err);
    }
  }

  function renderTransactions(search = "") {
    const tbody = document.getElementById('transactionList');
    if (!tbody) return;
    const searchLower = search.trim().toLowerCase();

    // Filter by Transaction ID or Receipt ID
    const filtered = searchLower
      ? allTransactions.filter(tx =>
          (tx.transaction_id && tx.transaction_id.toLowerCase().includes(searchLower)) ||
          (tx.friendly_id && tx.friendly_id.toLowerCase().includes(searchLower))
        )
      : allTransactions;

    tbody.innerHTML = '';
    filtered.forEach(tx => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${tx.customer_name}</td>
        <td>${tx.email}</td>
        <td>${tx.phone || '-'}</td>
        <td>${tx.transaction_id}</td>
        <td>${tx.friendly_id}</td>
        <td>${new Date(tx.order_date).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function filterTransactions() {
    const search = document.getElementById('transactionSearchInput').value;
    renderTransactions(search);
  }

  let allActiveUsers = [];

  async function loadActiveUsers() {
    try {
      const res = await fetch(`${API_BASE}/admin/active-users`, { credentials: 'include' });
      allActiveUsers = await res.json();
      renderActiveUsersDropdowns();
    } catch (err) {
      console.error('Failed to load active users', err);
    }
  }

  function filterActiveUsers() {
    const search = document.getElementById('activeUserSearchInput').value.trim().toLowerCase();
    renderActiveUsersDropdowns(search);
  }

  function renderActiveUsersDropdowns(search = "") {
    // Group users by role
    const groups = {
      'adult-athlete': [],
      'athlete': [],
      'admin': []
    };

    // Lowercase search for comparison
    const searchLower = search.trim().toLowerCase();

    // Filter users by name or email if searching
    allActiveUsers.forEach(user => {
      if (
        !searchLower ||
        (user.full_name && user.full_name.toLowerCase().includes(searchLower)) ||
        (user.email && user.email.toLowerCase().includes(searchLower))
      ) {
        if (groups[user.role]) {
          groups[user.role].push(user);
        }
      }
    });

    // Role display mapping
    function getRoleDisplay(role) {
      if (role === 'adult-athlete') return 'Adult Athlete';
      if (role === 'athlete') return 'Parent/Guardian';
      if (role === 'admin') return 'Admin';
      return role.charAt(0).toUpperCase() + role.slice(1);
    }

    // Dropdown order and labels
    const dropdowns = [
      { role: 'adult-athlete', label: 'Adult Athletes' },
      { role: 'athlete', label: 'Parents/Guardians' },
      { role: 'admin', label: 'Admins' }
    ];

    const container = document.getElementById('activeUsersDropdowns');
    container.innerHTML = '';

    dropdowns.forEach(({ role, label }) => {
      const users = groups[role];

      // If searching, only show dropdowns with matches
      if (searchLower && users.length === 0) return;

      // Create dropdown
      const wrapper = document.createElement('div');
      wrapper.className = 'package-section';

      const header = document.createElement('button');
      header.className = 'dropdown-btn';
      header.type = 'button';
      header.innerHTML = `
        ${label}
        <span class="athlete-bubble">${users.length}</span>
      `;

      const content = document.createElement('div');
      content.className = 'dropdown-content';

      // If searching, always open the dropdown for matching groups
      if (searchLower) {
        content.classList.add('show');
      }

      if (users.length > 0) {
        const table = document.createElement('table');
        table.className = 'table table-bordered table-sm';
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th>
              <th>Role</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Member</th>
            </tr>
          </thead>
          <tbody>
            ${users.map(user => `
              <tr>
                <td>${user.full_name}</td>
                <td>${getRoleDisplay(user.role)}</td>
                <td>${user.email}</td>
                <td>${user.phone || '-'}</td>
                <td>
                  <label class="form-check-label" style="margin-bottom:0;">
                    <input class="form-check-input" type="checkbox"
                      ${user.is_member ? 'checked' : ''}
                      onchange="toggleMember(${user.customer_id}, this.checked, this)" />
                    <span class="member-status-text">${user.is_member ? 'Yes' : 'No'}</span>
                  </label>
                </td>
              </tr>
            `).join('')}
          </tbody>
        `;
        content.appendChild(table);
      } else {
        content.innerHTML = `<p>No users in this group.</p>`;
      }

      // Dropdown toggle (only allow manual toggle if not searching)
      header.onclick = () => {
        if (!searchLower) content.classList.toggle('show');
      };

      // If this dropdown was open before, keep it open (unless searching)
      if (!searchLower && openDropdowns.includes(label)) {
        content.classList.add('show');
      }

      wrapper.appendChild(header);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    });
  }

  // Place the toggle function here:
  async function toggleMemberPricing(userId, checked) {
    await fetch(`${API_BASE}/admin/toggle-member/${userId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ hasMemberPricing: checked })
    });
    // Optionally reload users or show a toast
  }

  async function toggleMember(customerId, checked, checkbox) {
    const res = await fetch(`${API_BASE}/admin/customer/${customerId}/membership`, {
      method: 'PUT',
      headers: { 
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify({ isMember: checked })
    });
    const result = await res.json();
    console.log("Updated membership:", result);

    // Update the text next to the checkbox
    if (checkbox) {
      const statusSpan = checkbox.parentElement.querySelector('.member-status-text');
      if (statusSpan) statusSpan.textContent = checked ? 'Yes' : 'No';
    }
  }


  document.addEventListener('DOMContentLoaded', () => {
    loadTransactions();
    loadActiveUsers();
  });
</script>

</body>
</html>
