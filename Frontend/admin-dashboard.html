<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <!-- Poppins & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <!-- Cropper.js CSS -->
<link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
  <style>
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100%;
      background-color: #343a40;
      color: white;
      padding-top: 1rem;
      display: none;
      z-index: 999;
    }

    #sidebarcontainer{
       margin-top: 36px;
    }

    .sidebar a {
      padding: 10px 20px;
      display: block;
      color: white;
      text-decoration: none;
      cursor: pointer;
    }

    .sidebar a:hover {
      background-color: #495057;
    }

    .profile-dropdown {
      position: relative;
    }

    #mainContent {
      margin-left: 30px;
      padding: 20px;
      transition: margin-left 0.3s;
    }
    body.sidebar-open #mainContent {
      margin-left: 240px;
    }

    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    form label {
      display: block;
      margin: 10px 0 5px;
    }

    form input, form textarea {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
    }

    button {
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Athlete Box Styles */
    .package-box-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .package-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 700px;
      box-sizing: border-box;
      color: white;
    }

    .package-box input[name="athleteName"] {
      width: 95%; /* or any smaller value you want */
    }

    .add-package-box {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 300px;
      height: 500px;
      border: 2px dashed #ff4800;
      border-radius: 12px;
      font-size: 200px;
      font-weight: 50px;
      color: #ff4800;
      cursor: pointer;
      background-color: transparent;
    }

    .add-package-box:hover{
      background-color: #ff4800;
      color: #2a2f36;
    }

    /* Coach Assignment Box Styling */
    .assign-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 300px;
      color: white;
      box-sizing: border-box;
      margin-bottom: 20px;
    }

    .package-selectable {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }

    .package-tag {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 5px 0;
      cursor: pointer;
    }
    .package-tag span:last-child {
      margin-left: 8px;
    }

    .package-tag.selected {
      background-color: #4caf50;
      color: white;
      border-color: #4caf50;
    }

    /* Optional: layout similar to .package-box-container */
    #coachAssignmentsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }


    select[multiple] {
      height: 100px;
      width: 100%;
    }

    .story-box-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .story-box {
      position: relative;
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      width: 340px;
      box-sizing: border-box;
      color: white;
    }

    .add-story-box {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 340px; 
      border: 2px dashed #ff4800;
      border-radius: 12px;
      font-size: 100px;
      font-weight: bold;
      color: #ff4800;
      cursor: pointer;
      background-color: transparent;
    }

    .add-story-box:hover {
      background-color: #ff4800;
      color: #2a2f36;
    }

    .delete-story-btn {
      position: absolute;
      top: -5px;
      right: -12.5px;
      background: none;
      border: none;
      font-size: 30px;
      color: #ff4800;
      cursor: pointer;
    }

    .delete-story-btn:hover {
      color: red;
    }

    .choose-image-btn {
      background: #f5f5f5;
      color: #222;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.95rem;
      height: 32px;
      line-height: 1.2;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 1px 1px 2px #0001;
    }

    .choose-image-btn:hover {
      background: #eee;
      color: #ff4800;
      border-color: #ff4800;
    }

    .image-upload-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px; /* Add this line for spacing */
    }

    .package-section {
      margin-bottom: 10px;
    }

    .dropdown-btn {
      width: 100%;
      text-align: left;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background: #2a2f36;
      border: none;
      outline: none;
      border-radius: 6px 6px 0 0;
      font-weight: 600;
    }

    .dropdown-btn:hover {
      background: #ff4800;
      color: white;
    }

    .dropdown-content {
      display: none;
      padding: 10px;
      border: 1px solid #ddd;
      border-top: none;
      background: #fff;
      border-radius: 0 0 6px 6px;
    }

    .dropdown-content.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark px-3" style="z-index: 1000; ">
    <a class="navbar-brand" href="#">Admin Panel</a>
   
    <!-- Profile Dropdown -->
    <div class="dropdown profile-dropdown">
      <button class="btn btn-outline-light dropdown-toggle" id="profileBtn" data-bs-toggle="dropdown">
        Menu
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="#" id="toggleSidebar">Admin Menu</a></li>
        <li><a class="dropdown-item" href="/home" id="toggleSite">Website</a></li>
        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a></li>
      </ul>
    </div>
  </nav>


  <!-- Sidebar -->
  <div class="sidebar bg-dark" id="sidebarMenu">
    <div id="sidebarcontainer"> 
      <a onclick="showSection('dashboard')">üè† Dashboard</a>
      <a onclick="showSection('coachRegistry')">üìã Coach Registry</a>
      <a onclick="showSection('addPackages')">üì¶ Add Packages</a>
      <a onclick="showSection('athlete-packages')">üéüÔ∏è Athlete Packages</a>
      <a onclick="showSection('manageStories')">üèÖ Manage Success Stories</a>
      <button id="closeSidebarBtn" style="margin: 10px 0 0 0; color:white; cursor:pointer;">Close Sidebar</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent">
    <section id="dashboard" class="page-section">
      <h1>Welcome, Admin</h1>
      <p>This is your dashboard. Use the menu to navigate through admin functions like coach registry, adding packages, and assigning coaches.</p>
    </section>


    <section id="coachRegistry" class="page-section">
      <h2>Coach Registry</h2>
      <p>Here you can manage and view all registered coaches.</p>
      <div id="pendingCoachesContainer">
        <div class="pending-coaches-list"></div>
      </div>
      <div id="approvedCoachesContainer">
        <h4>Approved Coaches</h4>
        <div class="approved-coaches-list"></div>
      </div>
    </section>

    <section id="addPackages" class="page-section">
      <h2>Add Packages</h2>
      <p>Create new training or service packages for athletes and customers.</p>
      <div class="package-box-container">
        <!-- First Package Form -->
        <div class="package-box">
          <form class="packageInfoForm">
            <label for="packageTitle">Package Title</label>
            <input type="text" id="packageTitle" name="packageTitle" />

            <label for="description">Description</label>
            <div style="position: relative;">
              <textarea id="description" maxlength="400" rows="4" placeholder="Enter a short paragraph description..." style="padding-bottom: 28px;"></textarea>
              <span class="descCharCount" style="position: absolute; bottom: 6px; right: 10px; font-size: 0.95em; color: #aaa;">0/400 Characters</span>
            </div>
   
            <!-- Features list input -->
            <label for="features">Features</label>
            <div class="features-list">
              <div class="feature-item d-flex mb-2">
                <input type="text" class="form-control me-2" name="features[]" placeholder="Enter a feature..." />
                <button type="button" class="btn btn-danger btn-sm" onclick="removeFeature(this)">‚àí</button>
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFeature(this)">+ Add Feature</button>
            </div>
           
            <label for="sessionNumber">Number of Sessions</label>
            <input type="text" id="sessionNumber" name="sessionNumber" />


            <label for="price">Price</label>
            <input type="text" id="price" name="price" />
           
            <!-- Calendly URL field -->
            <label for="calendlyUrl">Calendly URL</label>
            <input type="url" id="calendlyUrl" name="calendlyUrl" placeholder="https://calendly.com/your-link" />

            <button type="submit">Save Package</button>
          </form>
        </div>
   
        <!-- Add Package Button -->
        <div class="add-package-box" onclick="addPackageBox()">+</div>
      </div>
    </section>

    <section id="manageStories" class="page-section">
      <h2>Manage Success Stories</h2>
      <p>Click the add button to add athlete success stories to the homepage.</p>

      <div class="story-box-container">
        <div class="story-box">
          <button class="delete-story-btn material-symbols-outlined" onclick="this.closest('.story-box').remove()">close</button>
          <form class="storyForm" enctype="multipart/form-data" onsubmit="return false;">
            <label>Athlete Name</label>
            <input type="text" name="athleteName" required />

            <label>Success Story</label>
            <textarea name="storyText" rows="4" required></textarea>

            <label>Image</label>
            <div class="image-upload-wrapper" style="display: flex; align-items: center; gap: 10px;">
              <input type="file" name="athleteImage" accept="image/*" class="image-input" style="display:none;" />
              <img class="image-preview" src="img/placeholder.png" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ff4800;" />
              <button type="button" class="choose-image-btn" style="margin-left: 10px;">Choose Image</button>
            </div>

            <button type="submit">Save Story</button>
          </form>
        </div>
        <div class="add-story-box" onclick="addStoryBox()">+</div>
      </div>

      <div id="storyList" style="margin-top: 20px;"></div>
    </section>

    <section id="athlete-packages" class="page-section">
      <h2>Athlete Packages</h2>
      <div id="package-dropdowns"></div>
    </section>


  </div>

  <script src="authStatus.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    // Use local backend if running locally, otherwise use deployed backend
    
    // Redirect to login if not authenticated
    if (!localStorage.getItem("token")) {
      window.location.href = "/login";
    }

    function logout() {
      try {
        const token = localStorage.getItem("token");
        fetch(`${API_BASE}/auth/logout`, {
          method: 'POST',
          credentials: 'include',
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
      } catch (err) {
        console.error("Logout request failed:", err);
      }
      localStorage.removeItem("token");
      sessionStorage.clear();
      window.location.href = "/home";
    }

    document.addEventListener('DOMContentLoaded', async function () {
      // 1. Auth check
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`${API_BASE}/auth/verify`, {
          credentials: "include",
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        const data = await res.json();
        if (!res.ok || !data.loggedIn || data.user.role !== 'admin') {
          window.location.href = "/home";
          return;
        }
      } catch (err) {
        console.error("Access check failed", err);
        window.location.href = "/home";
        return;
      }

      // 2. Sidebar/menu logic
      const sidebar = document.getElementById('sidebarMenu');
      const menuBtn = document.getElementById('toggleSidebar');
      const closeBtn = document.getElementById('closeSidebarBtn');
      let currentSection = 'dashboard';
      let sidebarOpen = false;

      function pushState(sectionId, sidebarOpen) {
        history.pushState({ sectionId, sidebarOpen }, '', '');
      }

      function showSection(sectionId) {
        currentSection = sectionId;
        document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
        const target = document.getElementById(sectionId);
        if (target) {
          target.classList.add('active');
          if (sectionId === 'coachRegistry') {
            loadPendingCoaches();
            loadApprovedCoaches();
          }
          if (sectionId === 'manageStories') {
            loadStories();
          }
          if (sectionId === 'athlete-packages') {
            loadAthletePackages();
          }
        }
        pushState(currentSection, sidebarOpen);
      }
      window.showSection = showSection;

      // Sidebar open/close
      menuBtn.addEventListener('click', function(e) {
        e.preventDefault();
        sidebarOpen = !sidebarOpen;
        sidebar.style.display = sidebarOpen ? 'block' : 'none';
        document.body.classList.toggle('sidebar-open', sidebarOpen);
        pushState(currentSection, sidebarOpen);
      });
      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        sidebarOpen = false;
        sidebar.style.display = 'none';
        document.body.classList.remove('sidebar-open');
        pushState(currentSection, sidebarOpen);
      });

      // Handle browser navigation
      window.addEventListener('popstate', function(event) {
        const state = event.state;
        if (state) {
          currentSection = state.sectionId || 'dashboard';
          sidebarOpen = !!state.sidebarOpen;
          showSection(currentSection);
          sidebar.style.display = sidebarOpen ? 'block' : 'none';
          document.body.classList.toggle('sidebar-open', sidebarOpen);
        }
      });

      // Set initial state and show dashboard
      pushState(currentSection, sidebarOpen);
      showSection('dashboard');
    });
 
    function showSection(sectionId) {
      const sections = document.querySelectorAll('.page-section');
      sections.forEach(sec => sec.classList.remove('active'));
      const target = document.getElementById(sectionId);
      if (target) {
        target.classList.add('active');

        // Trigger coach loading if viewing coach registry
        if (sectionId === 'coachRegistry') {
          loadPendingCoaches();
          loadApprovedCoaches(); // <-- Add this line
        }
        if (sectionId === 'manageStories') {
          loadStories();
        }
        if (sectionId === 'athlete-packages') {
          loadAthletePackages();
        }
      }
    }
    // Accept Registered Coaches
    async function loadPendingCoaches() {
      try {
        const res = await fetch(`${API_BASE}/admin/pending-coaches`, {
          credentials: 'include'
        });

        const coaches = await res.json();
        const list = document.querySelector(".pending-coaches-list");
        list.innerHTML = '';

        console.log("Pending Coaches Response:", coaches); // Optional debug

        coaches.forEach(coach => {
          if (!coach.coach_id) {  // Coach not yet approved
            const card = document.createElement("div");
            card.className = "assign-box";
            card.innerHTML = `
              <h5>${coach.first_name} ${coach.last_name}</h5>
              <p>Email: ${coach.email}</p>
              <button onclick="approveCoach(${coach.user_id}, '${coach.email}')">Approve Coach</button>

            `;
            list.appendChild(card);
          }
        });
      } catch (err) {
        console.error("Failed to load pending coaches", err);
      }
    }

    async function approveCoach(coachId, email) {
      const coachCode = Math.floor(1000 + Math.random() * 9000); // 4-digit ID

      const res = await fetch(`${API_BASE}/admin/approve-coach`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ coachId, email, coachCode })
      });

      const result = await res.json();
      if (res.ok) {
        alert(`Coach approved. Login ID ${coachCode} sent to ${email}`);
        loadPendingCoaches(); // Refresh list
      } else {
        alert(result.error || "Approval failed.");
      }
    }

    async function loadApprovedCoaches() {
      try {
        const res = await fetch(`${API_BASE}/admin/approved-coaches`, {
          credentials: 'include'
        });
        const coaches = await res.json();
        const list = document.querySelector(".approved-coaches-list");
        list.innerHTML = '';

        coaches.forEach(coach => {
          const card = document.createElement("div");
          card.className = "assign-box";
          card.innerHTML = `
            <h5>${coach.first_name} ${coach.last_name}</h5>
            <p>Email: ${coach.email}</p>
            <p>Coach ID: ${coach.coach_id}</p>
            <button onclick="fireCoach(${coach.id})" class="btn btn-danger">Fire Coach</button>
          `;
          list.appendChild(card);
        });
      } catch (err) {
        console.error("Failed to load approved coaches", err);
      }
    }

    async function fireCoach(coachId) {
      if (!confirm("Are you sure you want to fire this coach?")) return;

      try {
        const res = await fetch(`${API_BASE}/admin/fire-coach/${coachId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const result = await res.json();
        if (res.ok) {
          alert("Coach successfully fired.");
          loadApprovedCoaches();
        } else {
          alert(result.error || "Failed to fire coach.");
        }
      } catch (err) {
        console.error("Error firing coach", err);
      }
    }


    // Add Package Section
    function addFeature(button) {
      const container = button.parentElement;
      const featureItem = document.createElement('div');
      featureItem.className = 'feature-item d-flex mb-2';
      featureItem.innerHTML = `
        <input type="text" class="form-control me-2" name="features[]" placeholder="Enter a feature..." />
        <button type="button" class="btn btn-danger btn-sm" onclick="removeFeature(this)">‚àí</button>
      `;
      container.insertBefore(featureItem, button);
    }
 
    function removeFeature(button) {
      const featureItem = button.parentElement;
      featureItem.remove();
    }

    document.addEventListener('input', function (e) {
      if (e.target.matches('textarea[name="description"]')) {
        const span = e.target.parentElement.querySelector('.descCharCount');
        if (span) {
          span.textContent = `${e.target.value.length}/400 Characters`;
        }
      }
    });
 
    function createPackageForm(pkg = {}) {
      const box = document.createElement('div');
      box.className = 'package-box';
 
      const form = document.createElement('form');
      form.className = 'packageInfoForm';

      const featuresArray = Array.isArray(pkg.features) ? pkg.features : [];

      const descValue = pkg.description || '';
      form.innerHTML = `
        <label for="packageTitle">Package Title</label>
        <input type="text" name="packageTitle" value="${pkg.title || ''}" />

        <label for="description">Description</label>
        <div style="position: relative;">
          <textarea id="description" name="description" maxlength="400" rows="4" placeholder="Enter a short paragraph description..." style="padding-bottom: 28px;">${descValue}</textarea>
          <span class="descCharCount" style="position: absolute; bottom: 0px; right: 10px; font-size: 0.95em; color: #aaa;">${descValue.length}/400 Characters</span>
        </div>

        <label for="features">Features</label>
        <div class="features-list">
          ${(featuresArray.length > 0 ? featuresArray : ['']).map(desc => `
            <div class="feature-item d-flex mb-2">
              <input type="text" class="form-control me-2" name="features[]" value="${desc}" placeholder="Enter a feature..." />
              <button type="button" class="btn btn-danger btn-sm" onclick="removeFeature(this)">‚àí</button>
            </div>
          `).join('')}
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFeature(this)">+ Add Feature</button>
        </div>

        <label for="sessionNumber">Number of Sessions</label>
        <input type="text" name="sessionNumber" value="${pkg.sessions || ''}" />

        <label for="price">Price</label>
        <input type="text" name="price" value="${pkg.price || ''}" />

        <label for="calendlyUrl">Calendly URL</label>
        <input type="url" name="calendlyUrl" value="${pkg.calendlyUrl || ''}" placeholder="https://calendly.com/your-link" />

        <button type="submit">Save Package</button>
      `;
 
      form.addEventListener('submit', async function (e) {
        e.preventDefault();
 
        const formData = new FormData(form);
        const packageTitle = formData.get('packageTitle');
        const sessionNumber = formData.get('sessionNumber');
        const price = formData.get('price');
        const description = form.querySelector('textarea[name="description"]').value.trim();
        const features = formData.getAll('features[]').filter(item => item.trim() !== '');
        const calendlyUrl = formData.get('calendlyUrl');

        if (!description.length) {
          alert("Please add at least one feature description.");
          return;
        }
 
        const payload = {
          packageTitle,
          sessionNumber,
          price,
          description,
          features,
          calendlyUrl
        };
 
        const method = pkg.id ? 'PUT' : 'POST';
        const endpoint = pkg.id
          ? `${API_BASE}/admin/update-package/${pkg.id}`
          : `${API_BASE}/admin/create-package`;

        try {
          const response = await fetch(endpoint, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
    
          const result = await response.json();
          if (response.ok) {
            alert('Package saved!');
            console.log(result);

            if (!pkg.id && result.id) {
              // Store the returned ID in the pkg object and update form reference
              pkg.id = result.id;

              // Optionally update the submit handler so the form switches to PUT mode now
              form.removeEventListener('submit', arguments.callee); // remove current handler
              const newForm = createPackageForm(pkg); // re-render with ID
              box.replaceWith(newForm); // swap the box so it updates behavior
            }
          } else {
            alert('Failed to save package: ' + result.error);
          }
        } catch (error) {
          console.error('Error submitting package:', error);
          alert('An error occurred. Check console for details.');
        }
      });

      


      const deleteBtn = document.createElement('button');
      deleteBtn.innerHTML = '<span class="material-symbols-outlined">close</span>';
      deleteBtn.className = 'delete-package-btn';
      deleteBtn.style = `
        position: absolute;
        top: -5px;
        right: -12.5px;
        background: none;
        border: none;
        font-size: 30px;
        color: #ff4800;
        cursor: pointer;
      `;
      deleteBtn.onmouseover = () => deleteBtn.style.color = 'red';
      deleteBtn.onmouseout = () => deleteBtn.style.color = '#ff4800';
 
      if (pkg.id) {
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete this package?')) {
            try {
              const res = await fetch(`${API_BASE}/admin/delete-package/${pkg.id}`, {
                method: 'DELETE',
                credentials: 'include'
              });
              if (res.ok) {
                alert('Package deleted.');
                box.remove();
              } else {
                const result = await res.json();
                alert('Failed to delete package: ' + result.error);
              }
            } catch (err) {
              console.error('Error deleting package:', err);
              alert('An error occurred. Check console for details.');
            }
          }
        });
      } else {
        deleteBtn.addEventListener('click', () => box.remove());
      }
 
      box.appendChild(deleteBtn);
      box.appendChild(form);
      return box;
    }
 
    function addPackageBox() {
      const container = document.querySelector('.package-box-container');
      const addButton = document.querySelector('.add-package-box');
      const newBox = createPackageForm();
      container.insertBefore(newBox, addButton);
    }

    function enablePackageSorting() {
      const container = document.querySelector('.package-box-container');
      if (!container) return;
      Sortable.create(container, {
        animation: 150,
        handle: '.package-box', // Make the whole box draggable
        filter: '.add-package-box', // Prevent dragging the add button
        onEnd: function () {
          // Save the new order of package IDs to localStorage
          const order = Array.from(container.querySelectorAll('.packageInfoForm')).map(form => form.dataset.id);
          localStorage.setItem('packageOrder', JSON.stringify(order));
        }
      });
    }
 
    async function loadExistingPackages() {
      try {
        const response = await fetch(`${API_BASE}/admin/get-packages`, {
          credentials: 'include'
        });

        const packages = await response.json();
        if (response.ok) {
          const container = document.querySelector('.package-box-container');
          const addButton = document.querySelector('.add-package-box');
          container.innerHTML = '';

          // Get saved order from localStorage
          const savedOrder = JSON.parse(localStorage.getItem('packageOrder') || '[]');
          // Sort packages according to saved order
          const orderedPackages = savedOrder.length
            ? savedOrder
                .map(id => packages.find(pkg => String(pkg.id) === String(id)))
                .filter(Boolean)
                .concat(packages.filter(pkg => !savedOrder.includes(String(pkg.id))))
            : packages;

          orderedPackages.forEach(pkg => {
            const box = createPackageForm(pkg);
            // Make sure each form has a data-id for sorting
            box.querySelector('form').dataset.id = pkg.id;
            container.appendChild(box);
          });
          container.appendChild(addButton);

          enablePackageSorting(); // Enable drag-and-drop after rendering
        } else {
          alert('Failed to load packages: ' + packages.error);
        }
      } catch (err) {
        console.error('Error loading packages:', err);
      }
    }
 
    window.addEventListener('DOMContentLoaded', () => {
      loadExistingPackages();
    });


    document.addEventListener('DOMContentLoaded', () => {
      if (document.getElementById("storyList")) loadStories();
    });

    // Sort stories
    function enableStorySorting() {
      const container = document.querySelector('.story-box-container');
      if (!container) return;
      Sortable.create(container, {
        animation: 150,
        onEnd: function () {
          // Save the new order of story IDs to localStorage
          const order = Array.from(container.querySelectorAll('.storyForm')).map(form => form.dataset.id);
          localStorage.setItem('storyOrder', JSON.stringify(order));
        }
      });
    }
    async function loadStories() {
      const res = await fetch(`${API_BASE}/admin/stories`);
      const stories = await res.json();

      // Get saved order from localStorage
      const savedOrder = JSON.parse(localStorage.getItem('storyOrder') || '[]');
      // Sort stories according to saved order
      const orderedStories = savedOrder.length
        ? savedOrder
            .map(id => stories.find(story => String(story.id) === String(id)))
            .filter(Boolean)
            .concat(stories.filter(story => !savedOrder.includes(String(story.id))))
        : stories;

      const container = document.querySelector('.story-box-container');
      const addButton = document.querySelector(".add-story-box");
      container.innerHTML = ""; // Clear current story boxes

      orderedStories.forEach(story => {
        let imgSrc;
        if (story.image_url) {
          imgSrc = story.image_url.startsWith('http')
            ? story.image_url
            : `${API_BASE}${story.image_url}`;
        } else {
          imgSrc = 'img/placeholder.png';
        }

        const box = document.createElement("div");
        box.className = "story-box";
        box.innerHTML = `
          <button class="delete-story-btn material-symbols-outlined" onclick="deleteStory(${story.id}, this)">close</button>
          <form class="storyForm" data-id="${story.id}" enctype="multipart/form-data" onsubmit="return false;">
            <label>Athlete Name</label>
            <input type="text" name="athleteName" value="${story.name}" required />

            <label>Success Story</label>
            <textarea name="storyText" rows="4" required>${story.story}</textarea>

            <label>Image</label>
            <div class="image-upload-wrapper" style="display: flex; align-items: center; gap: 10px;">
              <input type="file" name="athleteImage" accept="image/*" class="image-input" style="display:none;" />
              <img class="image-preview" src="${imgSrc}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ff4800;" />
              <button type="button" class="choose-image-btn" style="margin-left: 10px;">Choose Image</button>
            </div>

            <button type="submit">Save Story</button>
          </form>
        `;
        box.querySelector("form").addEventListener("submit", handleStorySubmit);
        container.appendChild(box);
      });

      if (addButton) container.appendChild(addButton);
      enableStorySorting(); // Enable sorting after loading stories
    }

    function addStoryBox() {
      const container = document.querySelector('.story-box-container');
      const addButton = document.querySelector('.add-story-box');

      const box = document.createElement('div');
      box.className = 'story-box';
      box.innerHTML = `
        <button class="delete-story-btn material-symbols-outlined" onclick="this.closest('.story-box').remove()">close</button>
        <form class="storyForm" enctype="multipart/form-data" onsubmit="return false;">
          <label>Athlete Name</label>
          <input type="text" name="athleteName" required />

          <label>Success Story</label>
          <textarea name="storyText" rows="4" required></textarea>

          <label>Image</label>
          <div class="image-upload-wrapper" style="display: flex; align-items: center; gap: 10px;">
              <input type="file" name="athleteImage" accept="image/*" class="image-input" style="display:none;" />
              <img class="image-preview" src="img/placeholder.png" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ff4800;" />
              <button type="button" class="choose-image-btn" style="margin-left: 10px;">Choose Image</button>
            </div>

          <button type="submit">Save Story</button>
        </form>
      `;

      box.querySelector('form').addEventListener('submit', handleStorySubmit);
      container.insertBefore(box, addButton);
    }

    async function deleteStory(id, button) {
      if (!confirm("Are you sure you want to delete this story?")) return;

      try {
        const res = await fetch(`${API_BASE}/admin/delete-story/${id}`, {
          method: "DELETE"
        });

        if (res.ok) {
          alert("Story deleted.");
          button.closest(".story-box").remove();
        } else {
          const result = await res.json();
          alert(result.error || "Failed to delete.");
        }
      } catch (err) {
        console.error("Delete failed:", err);
        alert("Server error during delete.");
      }
    }

    async function handleStorySubmit(e) {
      e.preventDefault();
      const form = e.target;
      const storyId = form.dataset.id;

      const formData = new FormData();
      formData.append("athleteName", form.querySelector('[name="athleteName"]').value);
      formData.append("storyText", form.querySelector('[name="storyText"]').value);

      // Use the cropped blob for this form if it exists
      if (form.croppedBlob) {
        formData.append("athleteImage", form.croppedBlob, 'cropped.jpg');
      } else {
        const imageInput = form.querySelector('[name="athleteImage"]');
        if (imageInput && imageInput.files.length > 0) {
          formData.append("athleteImage", imageInput.files[0]);
        }
      }

      const url = storyId
        ? `${API_BASE}/admin/update-story/${storyId}`
        : `${API_BASE}/admin/add-story`;

      const method = storyId ? "PUT" : "POST";

      try {
        const res = await fetch(url, {
          method,
          body: formData
        });

        const result = await res.json();

        if (res.ok) {
          alert(storyId ? "Story updated!" : "Story added!");
          loadStories(); // Refresh UI
          showSection('manageStories'); // Ensure the section stays visible
        } else {
          alert(result.error || "Failed to save story.");
        }
      } catch (err) {
        console.error("Error submitting story:", err);
        alert("Error submitting story.");
      }
    }

    let cropper = null;
    let currentImageInput = null;
    let currentPreview = null;
    let currentForm = null;
    let croppedBlob = null;

    // Open crop modal when image is selected
    document.body.addEventListener('change', function(e) {
      if (e.target.classList.contains('image-input')) {
        const input = e.target;
        const file = input.files[0];
        if (!file) return;

        const form = input.closest('form');
        const preview = form.querySelector('.image-preview');
        const reader = new FileReader();

        if (window.location.hostname === "localhost") {
          // Local: open crop modal
          currentImageInput = input;
          currentForm = form;
          currentPreview = preview;
          reader.onload = function(evt) {
            const cropModal = document.getElementById('cropModal');
            const cropImage = document.getElementById('cropImage');
            cropImage.src = evt.target.result;
            cropModal.style.display = 'flex';

            if (cropper) cropper.destroy();
            cropper = new Cropper(cropImage, {
              aspectRatio: 1,
              viewMode: 1,
              autoCropArea: 1,
            });
          };
          reader.readAsDataURL(file);
        } else {
          // Production/Supabase: show direct preview
          reader.onload = function(evt) {
            preview.src = evt.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      }
    });

    document.addEventListener('DOMContentLoaded', function() { 
      // Confirm crop
      document.getElementById('confirmCropBtn').addEventListener('click', function() {
        if (cropper && currentPreview && currentForm) {
          cropper.getCroppedCanvas({
            width: 300,
            height: 300
          }).toBlob(blob => {
            // Store the cropped blob on the form
            currentForm.croppedBlob = blob;
            currentPreview.src = URL.createObjectURL(blob);
            currentPreview.style.display = 'block';
            document.getElementById('cropModal').style.display = 'none';
            cropper.destroy();
            cropper = null;
          }, 'image/jpeg');
        }
      });

      // Cancel crop
      document.getElementById('cancelCropBtn').addEventListener('click', function() {
        document.getElementById('cropModal').style.display = 'none';
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      });

    });

    
    // Allow clicking preview to replace image
    document.body.addEventListener('click', function(e) {
      // Click "Choose Image" button
      if (e.target.classList.contains('choose-image-btn')) {
        const form = e.target.closest('form');
        const input = form.querySelector('.image-input');
        if (input) {
          // Reset the input value so selecting the same file triggers 'change'
          input.value = '';
          input.click();
        }
      }
    });

    // When file is chosen, open crop modal
    document.body.addEventListener('change', function(e) {
      if (e.target.classList.contains('image-input')) {
        const input = e.target;
        const file = input.files[0];
        if (!file) return;

        currentImageInput = input;
        currentForm = input.closest('form');
        currentPreview = currentForm.querySelector('.image-preview');

        const reader = new FileReader();
        reader.onload = function(evt) {
          const cropModal = document.getElementById('cropModal');
          const cropImage = document.getElementById('cropImage');
          cropImage.src = evt.target.result;
          cropModal.style.display = 'flex';

          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
          });
        };
        reader.readAsDataURL(file);
      }
    });

    
    // Trigger loading when "Assign Coaches" section is shown
    function showSection(sectionId) {
      localStorage.setItem('adminSection', sectionId); // Remember the section

      document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
      const target = document.getElementById(sectionId);
      if (target) {
        target.classList.add('active');

        if (sectionId === 'coachRegistry') {
          loadPendingCoaches();
          loadApprovedCoaches();
        }
        if (sectionId === 'manageStories') {
          loadStories();
        }
        if (sectionId === 'athlete-packages') {
          loadAthletePackages();
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      if (!document.querySelector('.page-section.active')) {
        showSection('dashboard');
      }
    });
    
  </script>

    <div id="deleteModal" style="display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
      <div style="background:white; padding:20px; max-width:400px; margin:15% auto; border-radius:8px; text-align:center;">
        <p style="color:#ff4800">Do you want to delete this timeslot or all future ones?</p>
        <button id="deleteOneBtn">Delete One</button>
        <button id="deleteAllBtn">Delete Future</button>
        <button id="cancelDeleteBtn">Cancel</button>
      </div> <!--Make the styling of most of like my log buttons like this popup-->
    </div>

    <!-- Crop Image Modal -->
    <div id="cropModal" style="display:none; position:fixed; z-index:2000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
      <div style="background:#222; padding:24px 24px 16px 24px; border-radius:12px; max-width:90vw; max-height:90vh; text-align:center; position:relative;">
        <img id="cropImage" style="max-width:70vw; max-height:60vh; background:#fff; border-radius:8px;" />
        <div style="margin-top:16px;">
          <button id="confirmCropBtn" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;">Confirm Crop</button>
          <button id="cancelCropBtn" style="padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer;">Cancel</button>
        </div>
      </div>
    </div>

<script>
let openDropdowns = [];

async function loadAthletePackages() {
  try {
    // Fetch all packages and all athlete usages
    const [packagesRes, usagesRes] = await Promise.all([
      fetch(`${API_BASE}/admin/all-packages`, { credentials: 'include' }),
      fetch(`${API_BASE}/admin/athlete-packages`, { credentials: 'include' })
    ]);
    const allPackages = await packagesRes.json();
    const usages = await usagesRes.json();

    // Group usages by package name
    const grouped = {};
    usages.forEach(pkg => {
      if (!grouped[pkg.package_name]) grouped[pkg.package_name] = [];
      grouped[pkg.package_name].push(pkg);
    });

    const container = document.getElementById('package-dropdowns');
    container.innerHTML = '';

    allPackages.forEach(pkg => {
      const packageName = pkg.name;
      const athletes = grouped[packageName] || [];
      // Sort: athletes with sessions_remaining > 0 first
      athletes.sort((a, b) => b.sessions_remaining - a.sessions_remaining);

      const wrapper = document.createElement('div');
      wrapper.classList.add('package-section');

      // Dropdown content (athlete list)
      const content = document.createElement('div');
      content.classList.add('dropdown-content');

      // Package header (clickable dropdown)
      const header = document.createElement('button');
      header.classList.add('dropdown-btn');
      header.textContent = packageName;
      header.onclick = () => {
        content.classList.toggle('show');
        // Update openDropdowns after toggle
        if (content.classList.contains('show')) {
          if (!openDropdowns.includes(packageName)) openDropdowns.push(packageName);
        } else {
          openDropdowns = openDropdowns.filter(name => name !== packageName);
        }
      };

      // If this dropdown was open before, keep it open
      if (openDropdowns.includes(packageName)) {
        content.classList.add('show');
      }

      if (athletes.length === 0) {
        content.innerHTML = `<p>No athletes booked for this package.</p>`;
      } else {
        const table = document.createElement('table');
        table.className = "table table-bordered table-sm";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Athlete</th>
              <th>Sessions Purchased</th>
              <th>Sessions Remaining</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${athletes.map(a => `
              <tr>
                <td>${a.athlete_name}</td>
                <td>${a.sessions_purchased}</td>
                <td>${a.sessions_remaining}</td>
                <td>
                  <button type="button" class="btn btn-warning btn-sm" onclick="event.stopPropagation(); updateSession(${a.usage_id}, -1)">-</button>
                  <button type="button" class="btn btn-success btn-sm" onclick="event.stopPropagation(); updateSession(${a.usage_id}, 1)">+</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        `;
        content.appendChild(table);
      }

      wrapper.appendChild(header);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    });
  } catch (err) {
    console.error('Error loading athlete packages:', err);
  }
}

// Update session count (subtract or add)
async function updateSession(usageId, delta) {
  await fetch(`${API_BASE}/admin/athlete-packages/${usageId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ subtract: -delta }) // negative delta for add, positive for subtract
  });
  // Do not reset openDropdowns, just reload data
  loadAthletePackages();
}
window.updateSession = updateSession;
</script>

</body>
</html>
