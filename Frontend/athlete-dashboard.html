<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <!-- Poppins & Icons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #333940;
      margin: 0;
      padding: 0;
      color: white;
    }

    header {
      background-color: #1e1e1e;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 28px;
    }

    section h1 {
      text-align: center;
      font-size: 30px
    }

    #sidebarLinksContainer a {
      margin-left: 15px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 20px 8px;
      /* border-radius: 6px; */
      transition: background 0.2s, color 0.2s;
    }

    #sidebarLinksContainer a:hover {
      background-color: #333940;
      color: #fff;
    }


    section {
      padding: 30px 20px;
      max-width: 1000px;
      margin: auto;
    }

    h2 {
      margin-bottom: 20px;
      color: #fff;
    }

    form label {
      display: block;
      margin: 10px 0 5px 8px;
      font-weight: 600;
      font-size: 1rem;
      text-align: left;
      width: 100%;
    }

    form input,
    form textarea,
    form select {
      width: 100%;
      font-size: 1rem;
      padding: 6px;
      border-radius: 5px;
      border: none;
      margin-bottom: 18px;
      box-sizing: border-box;
      background: #fff;
      color: #222;
    }

    button {
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #e03e00;
    }

    select {
      width: 102%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border-radius: 0.5rem;
      background-color: white;
      font-size: 1rem;
      margin-bottom: 15px;
    }

    select:focus {
      border-color: #ff4800;
      outline: none;
      background-color: white;
    }

    ul {
      list-style-type: none;
      padding: 0;
    }

    ul li {
      background: #444;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }

    .athlete-box-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
      max-width: 980px;
      margin: 0 auto;
    }

    .athlete-box,
    .add-athlete-box {
      height: 400px;
      width: 300px;
      box-sizing: border-box;
      margin: 0;
    }

    .athlete-box {
      background-color: #2a2f36;
      border: 2px solid #ff4800;
      border-radius: 12px;
      padding: 20px;
      color: white;
      text-align: center;
      position: relative;
    }

    .athlete-box input[name="athleteName"] {
      width: 95%; /* or any smaller value you want */
    }

    .add-athlete-box {
      display: flex;
      justify-content: center;
      align-items: center;
      border: 2px dashed #ff4800;
      border-radius: 12px;
      font-size: 200px;
      color: #ff4800;
      cursor: pointer;
      background-color: #2a2f36;
      transition: background 0.2s, color 0.2s;
    }

    .add-athlete-box:hover {
      background-color: #ff4800;
      color: #2a2f36;
    }

    .back-btn {
      font-family: Arial, Helvetica, sans-serif;
      position: fixed;
      top: 90px;
      right: 20px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      text-shadow: 0 2px 8px rgb(0, 0, 0); 
      z-index: 99;
    }

    .back-btn:hover {
      color:#ff4800;
    }

    #editInfo {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh; /* Adjust as needed */
    }
    #infoForm {
      width: 60%;
      /* max-width: 400px; */
      margin: 0 auto;
    }

    @media (max-width: 400px) {
      .athlete-box-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
    }

    @media (max-width: 1024px) {
      .material-symbols-outlined {
        font-size: 2.5rem !important;
      }
      form label {
        font-size: 1.2rem;
      }
      form input,
      form textarea,
      form select {
        font-size: 1rem;
        padding: 14px;
      }
      select {
        width: 105%;
        color:#000;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.25rem;
      }
      .athlete-box {
        padding: 45px;
        width: 350px;
        height: 450px;
        margin-left: auto;
        margin-right: auto;
      }

      .add-athlete-box {
        width: 350px;
        height: 450px;
        margin-left: auto;
        margin-right: auto;
      }
      button {
        font-size: 1rem;
      }
      #profileBtn {
        background: #333940;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 22px;
        transition: background 0.2s;
      }
      #profileBtn:hover {
        background: #ff4800;
        color: #fff;
      }
      .sidebar {
          position: fixed;
          top: 0;
          right: 0;
          width: 275px;
          height: 100%;
          background-color: #343a40;
          box-shadow: -10px 0 20px #24282c;
          padding-top: 1rem;
          display: none;
          z-index: 999;
          transition: all 0.3s ease-in-out;
      }

      .sidebar a {
          padding: 10px 20px;
          color: white;
          display: block;
          text-decoration: none;
          transition: background-color 0.3s ease;
      }

      .sidebar a:hover {
          background-color: rgba(255, 60, 0, 0.574);
          color: white;
      }

      .sidebar-link-margin {
          margin-top: 0.6rem !important;
      }

      .close-btn {
          background-color: #ff4800;
          color: white;
          position: absolute;
          top: 1rem;
          right: 10px;
          padding: 2.5px 5px;
          border-radius: 50px;
          border: none;
      }
      #sidebarLinksContainer {
        display: none !important;
      }
      #profileBtn {
        display: inline-block !important;
      }
    }

    .booking-btn {
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .booking-btn:hover {
      background-color: #e03e00;
      color: #fff;
    }

    #packageBookingContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 220px; /* or whatever height you want */
    }

   
    #bookSessions .athlete-box-container .athlete-box {
      height: 250px;     
      width: 300px;       
      padding: 40px 20px; 
      font-size: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .field-error {
      display: none;
      background: #fffbe6;
      color: #b8860b;
      border: 1px solid #ffe58f;
      border-radius: 5px;
      padding: 6px 12px;
      margin-bottom: 10px;
      font-size: 0.97rem;
      align-items: center;
      gap: 8px;
    }
    .field-error.active {
      display: flex;
    }
    .field-error .icon {
      font-weight: bold;
      margin-right: 6px;
      color: #b8860b;
    }

    .popup-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #343a40;
      color: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
      z-index: 9999;
      font-size: 18px;
      text-align: center;
      max-width: 400px;
    }
    .popup-modal .icon {
      font-size: 2rem;
      margin-right: 8px;
      color: #ffa162;
      vertical-align: middle;
    }
    .popup-modal button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #ff4800;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    @media (max-width: 600px) {
      .popup-modal {
        width: 95vw;
        max-width: 700px;
        min-width: 0;
        /* min-height: 320px; */
        height: auto;
        padding: 40px 16px;
        border-radius: 8px;
        box-shadow: 0 5px 15px black;
        background: #343a40;
        color: white;
        font-size: 1.1rem;
        line-height: 1.5;
        margin: 0 auto;
      }

      .popup-modal .icon {
        font-size: 2rem;
        margin-bottom: 18px;
        display: block;
      }
    }

    /* Calendly Modal */
    #calendlyModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #calendlyModal > .calendly-modal-content {
      background: #343a40;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }
    #calendlyModal .calendly-modal-close {
      position: absolute;
      top: 10px;
      right: 30px;
      background: none;
      border: none;
      font-size: 48px;
      color: #ff4800 !important;
      cursor: pointer;
      transition: color 0.2s;
    }
    #calendlyModal .calendly-modal-close:hover {
      color: red !important;
    }

    .calendly-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .calendly-modal-content {
      background: #343a40;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }

  </style>
</head>
<body>
<header>
  <h1>Dashboard</h1>
  <nav id="sidebarLinksContainer">
    <a href="#editInfo">Edit Info</a>
    <a href="#athleteInfo">Add Athlete</a>
    <a href="#bookSessions">Schedule Sessions</a>
    <a href="javascript:void(0)" id="sidebarLogoutBtn" class="text-danger px-3 py-2 text-decoration-none">Logout</a>
  </nav>
  <button id="profileBtn" class="btn btn-outline-light" style="display:none;">
    <i class="bx bx-user"></i>
  </button>
</header>

<div id="profileSidebar" class="sidebar bg-dark text-white" style="display:none;">
  <button class="btn btn-sm btn-outline-light ms-2 mt-2 close-btn" onclick="toggleSidebar()">× Close</button>
  <div class="mt-4 d-flex flex-column">
    <a style="margin-top: 20px;" href="#editInfo">Edit Info</a>
    <a href="#athleteInfo">Add Athlete</a>
    <a href="#bookSessions">Schedule Sessions</a>
    <a href="javascript:void(0)" id="logoutBtn" class="text-danger px-3 py-2 text-decoration-none">Logout</a>
  </div>
</div>

<div id="globalBackBtn" class="back-btn" onclick="handleBackClick()">
  <i class="fas fa-arrow-left">Home</i>
</div>

<!-- Edit Personal Info -->
<section id="editInfo" style="margin-top: 25px;">
  <h1>Parent/Guardian Info</h1>
  <p style="text-align:center; max-width:600px; margin:0 auto 30px auto; color:#fff; font-size:.9rem; text-shadow:0 2px 8px #000;">
    Please ensure your information is accurate to avoid booking issues.<br>
    Click <strong>"Save Info"</strong> below to update your information at any time.
  </p>
  <form id="infoForm">
    <label for="Name">Name</label>
    <input type="text" id="name" name="name" />
    <div class="field-error" id="nameError"></div>

    <label for="Email">Email</label>
    <input
      type="email"
      id="email"
      name="email"
      value=""
      readonly
      class="locked-input"
      required
      pattern="^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$"
      placeholder="Enter your email"
      oninvalid="this.setCustomValidity('Please enter a valid email address.')"
      oninput="this.setCustomValidity('')"
    />
    <div class="field-error" id="emailError"></div>

    <label for="Phone">Phone</label>
    <input
      type="tel"
      id="phone"
      name="phone"
      pattern="^\d{10,15}$"
      inputmode="tel"
      maxlength="15"
      required
      placeholder="Enter phone number (digits only)"
      oninvalid="this.setCustomValidity('Please enter a valid phone number (digits only, 10-15 digits).')"
      oninput="this.setCustomValidity('')"
    />
    <div class="field-error" id="phoneError"></div> 

    <button type="submit" id="saveInfoBtn">Save Info</button>
  </form>
</section>

<!-- Add Athlete Info -->
<section id="athleteInfo"  style="margin-top: 55px;">
  <h1>Add Athlete For Booking</h1>
  <p style="text-align:center; max-width:600px; margin:0 auto 30px auto; color:#fff; font-size:.9rem; text-shadow:0 2px 8px #000;">
    Add your youth athlete(s) here. You can add multiple athletes if needed.
    Click <strong>"Save Info"</strong> below to update their information at any time.
  </p>
  <div class="athlete-box-container">
    <!-- First Athlete Form -->
    <div class="athlete-box">
      <form class="athleteInfoForm">
        <label for="athleteName">Name</label>
        <input type="text" id="athleteName" name="athleteName" />

        <label for="ageGroup">Age Group</label>
        <select id="ageGroup" name="ageGroup">
          <option value="" selected>--</option>
          <option value="8 & Under">8 & Under</option>
          <option value="9-10">9 - 10 years old</option>
          <option value="11-12">11 - 12 years old</option>
          <option value="13-14">13 - 14 years old</option>
          <option value="15-16">15 - 16 years old</option>
          <option value="17-18">17 - 18 years old</option>
          <option value="18+">18+ years old</option>
        </select>

        <label for="sport">Sport</label>
        <select id="sport" name="sport">
          <option value="" selected>--</option>
          <option value="Track & Field">Track & Field</option>
          <option value="Cross Country">Cross Country</option>
          <option value="Football">Football</option>
          <option value="Lacrosse">Lacrosse</option>
          <option value="Basketball/Softball">Basketball/Softball</option>
          <option value="Baseball">Baseball</option>
          <option value="Soccer">Soccer</option>
          <option value="Other">Other</option>
        </select>

        <button type="submit" class="saveAthleteBtn">Save Info</button>
      </form>
    </div>

    <!-- Add Athlete Button -->
    <div class="add-athlete-box" onclick="addAthleteBox()">+</div>
  </div>
</section>

<!-- Schedule Sessions (PAID PACKAGES ONLY) -->
<section id="bookSessions" style="margin-top: 55px; margin-bottom: 55px;">
  <h1>Schedule Your Sessions</h1>
  <div id="packageBookingContainer" class="athlete-box-container"></div>
  <div style="text-align:center; margin-top: 30px;">
    <button
      class="booking-btn"
      onclick="window.location.href='/packages'"
      style="font-size:1.2rem; padding:12px 32px; border-radius:8px; margin-top:10px;"
    >
      Explore Packages
    </button>
  </div>
</section>

<!-- Calendly Modal Overlay -->
<div id="calendlyModal" class="calendly-modal-overlay">
  <div class="calendly-modal-content">
    <button onclick="closeCalendly()" class="calendly-modal-close" aria-label="Close">&times;</button>
    <div id="calendlyInline" style="min-width:320px; height:500px;"></div>
  </div>
</div>

<script src="authStatus.js"></script>
<script src="https://assets.calendly.com/assets/external/widget.js" async></script>
<script>

  (async function checkRole() {
    const res = await fetch(`${API_BASE}/auth/me`, {
      credentials: 'include',
    });
    const data = await res.json();
    if (!data.user || data.user.role !== 'athlete') {
      showGlobalPopup('Not authorized for Youth Athlete Dashboard', "/login");
    }
  })();

  function handleBackClick() {
     window.location.href = "/";
  }

  // window.addEventListener("DOMContentLoaded", () => {
  //   const isFirstLogin = sessionStorage.getItem("isFirstLogin");
  //   if (isFirstLogin === "true") {
  //     // Use the globally loaded customerData if available
  //     let firstName = "";
  //     if (customerData && customerData.first_name) {
  //       firstName = customerData.first_name;
  //     }
  //     document.getElementById("firstLoginName").textContent = firstName;
  //     document.getElementById("firstLoginPopup").style.display = "block";
  //     sessionStorage.removeItem("isFirstLogin"); // Prevent future triggers
  //   }
  // });
  
  function closeFirstLoginPopup() {
    document.getElementById("firstLoginPopup").style.display = "none";
  }

  // Initialize global variables for user ID, calendar instance, and customer ID
  let userId = null;
  let customerId = null;

  // Store customer data globally after loading
  let customerData = {};

  async function loadPaidPackages() {
  if (!customerId) return;
  try {
    const res = await fetch(`${API_BASE}/athlete/paid-packages/${customerId}`, {
      credentials: 'include',
    });
    const packages = await res.json();

    const container = document.getElementById('packageBookingContainer');
    container.innerHTML = '';

    // Show instructional text only if there are paid packages
    if (packages.length > 0) {
      const infoP = document.createElement('p');
      infoP.style.textAlign = "center";
      infoP.style.maxWidth = "550px";
      infoP.style.margin = "0 auto 24px auto";
      infoP.style.color = "#fff";
      infoP.style.fontSize = ".9rem";
      infoP.style.textShadow = "0 2px 8px #000";
      infoP.innerHTML = `Select <strong>"Click to Schedule"</strong> on your athlete’s package. Calendly will open choose your timeslot and confirm. <br><br>Need more sessions? Click <strong>"Explore Packages"</strong> below.`;
      container.parentNode.insertBefore(infoP, container);
    } else {
      // Remove the instructional text if present
      const prev = container.previousElementSibling;
      if (prev && prev.tagName === "P" && prev.innerHTML.includes("Click to Schedule")) {
        prev.remove();
      }
    }

    if (!packages.length) {
      container.innerHTML = `
        <div class="athlete-box">
          <strong>No packages found.</strong><br>Click "Explore Packages" to purchase a package and schedule sessions.
        </div>
      `;
      return;
    }

    // Fetch all athletes for this customer
    let athleteMap = {};
    try {
      const athleteRes = await fetch(`${API_BASE}/athlete/${customerId}`, { credentials: 'include' });
      const athletes = await athleteRes.json();
      athletes.forEach(a => {
        athleteMap[a.id] = `${a.first_name}`;
      });
    } catch (err) {
      console.error('Error fetching athletes for package display:', err);
    }

    packages.forEach(pkg => {
      const athleteName = athleteMap[pkg.athlete_id] || 'Unknown Athlete';
      const box = document.createElement('div');
      box.className = 'athlete-box';

      box.innerHTML = `
        <h3>${pkg.name}</h3>
        <strong style="margin-bottom:0;">${athleteName}</strong>
        <p style="margin-top:2px;">Package Sessions: ${pkg.sessions_remaining ?? 'N/A'}</p>
        <button style="margin-top:10px;" class="book-calendly-btn" onclick="openCalendly('${pkg.calendly_url}')">
          Click to Schedule
        </button>
      `;
      container.appendChild(box);
    });
  } catch (err) {
    console.error('Error loading paid packages:', err);
    document.getElementById('packageBookingContainer').innerHTML = '<p>Error loading packages.</p>';
  }
}

  async function handleAthleteSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const athleteId = form.dataset.athleteId;

    // Get field values
    const fullName = form.querySelector('input[name="athleteName"]').value.trim();
    const [first_name, ...lastNameParts] = fullName.split(' ');
    const last_name = lastNameParts.join(' ') || '';
    const age_group = form.querySelector('select[name="ageGroup"]').value;
    const sport = form.querySelector('select[name="sport"]').value;

    if (!fullName || !age_group || !sport) {
      showAthleteErrorPopup("Fill in all fields to save.");
      return;
    }

    const method = athleteId ? 'PUT' : 'POST';
    const url = athleteId
      ? `${API_BASE}/athlete/${athleteId}`
      : `${API_BASE}/athlete`;

    try {
      const res = await fetch(url, {
        method,
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customer_id: customerId, first_name, last_name, age_group, sport })
      });

      const data = await res.json();
      if (res.ok) {
        // Show "Saved!" on the button for 2 seconds
        const saveBtn = form.querySelector('.saveAthleteBtn');
        if (saveBtn) {
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Saved!';
          saveBtn.disabled = true;
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }, 2500);
        }
        if (!athleteId) loadAthleteData(); // Refresh list after new insert
      } else {
        showAthleteErrorPopup(data.error || "Error saving athlete.");
      }
    } catch (err) {
      showAthleteErrorPopup("Error saving athlete.");
      console.error('Error saving athlete:', err);
    }
  }


  function addAthleteBox() {
    const container = document.querySelector('.athlete-box-container');
    const athleteBoxes = document.querySelectorAll('.athlete-box');
    const original = athleteBoxes[0];
    const clone = original.cloneNode(true);

    const form = clone.querySelector('form');
    form.reset();
    delete form.dataset.athleteId;

    // Reset error messages
    clone.querySelectorAll('.field-error').forEach(div => {
      div.classList.remove('active');
      div.textContent = '';
    });

    const newForm = form.cloneNode(true);
    form.replaceWith(newForm);
    newForm.addEventListener('submit', handleAthleteSubmit);

    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '<span class="material-symbols-outlined">close</span>';
    deleteBtn.className = 'delete-athlete-btn';
    deleteBtn.style = `
      position: absolute;
      top: -5px;
      right: -12.5px;
      background: none;
      border: none;
      font-size: 30     
      color: #ff4800;
      cursor: pointer;
    `;
    deleteBtn.onmouseover = () => deleteBtn.style.color = 'red';
    deleteBtn.onmouseout = () => deleteBtn.style.color = '#ff4800';
    deleteBtn.addEventListener('click', () => clone.remove());

    clone.appendChild(deleteBtn);

    const addButton = document.querySelector('.add-athlete-box');
    container.insertBefore(clone, addButton);
  }

  async function deleteAthlete(athleteId) {
    try {
      const res = await fetch(`${API_BASE}/athlete/${athleteId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (!res.ok) {
        const err = await res.json();
        showGlobalPopup('Delete failed: ' + err.error);
      } else {
        showGlobalPopup('Athlete deleted');
      }
    } catch (err) {
      console.error('Error deleting athlete:', err);
      showGlobalPopup('Delete failed');
    }
  }



  // Fetch logged-in user
  async function fetchLoggedInUser() {
    try {

      const res = await fetch(`${API_BASE}/auth/me`, {
        credentials: 'include', // try sending cookie
      });
      const data = await res.json();
      if (data.user && data.user.id) {
        userId = data.user.id;
      } else {
        throw new Error('User data not found');
      }
    } catch (error) {
      showGlobalPopup('Session expired or unauthorized. Please log in again.', "/login");
    }
  }

  // Load athlete info
  async function loadCustomerData() {
    await fetchLoggedInUser();
    try {
      const athleteRes = await fetch(`${API_BASE}/athlete/by-user/${userId}`, {
        credentials: 'include'
      });
      const athlete = await athleteRes.json();

      if (athleteRes.ok) {
        customerId = athlete.customer.id;
        customerData = athlete.customer; // <-- Store for Calendly
        document.getElementById("name").value = (athlete.customer.first_name || "") + (athlete.customer.last_name ? " " + athlete.customer.last_name : "");
        document.getElementById("email").value = athlete.customer.email || "";
        document.getElementById("phone").value = athlete.customer.phone || "";
      }
    } catch (error) {
      console.error('Error loading client data:', error);
    }
  }

  function openCalendly(url) {
  const name = (customerData.first_name || "") + (customerData.last_name ? " " + customerData.last_name : "");
  const email = customerData.email || "";

  // Determine if we need ? or &
  const joinChar = url.includes('?') ? '&' : '?';

  Calendly.initInlineWidget({
    url: url +
      joinChar +
      `hide_gdpr_banner=1` +
      `&background_color=343a40` +
      `&text_color=ffffff` +
      `&primary_color=ff4800` +
      `&name=${encodeURIComponent(name)}` +
      `&email=${encodeURIComponent(email)}`,
    parentElement: document.getElementById("calendlyInline"),
    prefill: {
      name: name,
      email: email,
    },
  });

  document.getElementById("calendlyModal").style.display = "flex";

  // Listen for event scheduled
  function calendlyListener(e) {
    if (e.data.event && e.data.event.indexOf("calendly.event_scheduled") === 0) {
      closeCalendly();
      showGlobalPopup("Your session has been scheduled! Confirmation sent to your email. \n\nNote: Your package sessions will decrease after you attend.");
      window.removeEventListener("message", calendlyListener);
    }
  }
  window.addEventListener("message", calendlyListener);
}

function closeCalendly() {
  document.getElementById("calendlyModal").style.display = "none";
  document.getElementById("calendlyInline").innerHTML = ""; // reset for next time
}

  // Handle client form submission
  document.getElementById('infoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await fetchLoggedInUser();

    const fullName = document.getElementById("name").value.trim();
    const [first_name, ...lastNameParts] = fullName.split(' ');
    const last_name = lastNameParts.join(' ') || '';
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const phoneRegex = /^\d{10,15}$/;
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    // Clear previous errors
    document.getElementById("nameError").classList.remove("active");
    document.getElementById("emailError").classList.remove("active");
    document.getElementById("phoneError").classList.remove("active");
    document.getElementById("nameError").textContent = "";
    document.getElementById("emailError").textContent = "";
    document.getElementById("phoneError").textContent = "";

    let hasError = false;

    if (!fullName) {
      const nameError = document.getElementById("nameError");
      nameError.innerHTML = `<span class="icon">!</span> Please enter your full name.`;
      nameError.classList.add("active");
      hasError = true;
    }
    if (!phoneRegex.test(phone)) {
      const phoneError = document.getElementById("phoneError");
      phoneError.innerHTML = `<span class="icon">!</span> Please enter a valid phone number (digits only, 10-15 digits).`;
      phoneError.classList.add("active");
      hasError = true;
    }
    if (!emailRegex.test(email)) {
      const emailError = document.getElementById("emailError");
      emailError.innerHTML = `<span class="icon">!</span> Please enter a valid email address.`;
      emailError.classList.add("active");
      hasError = true;
    }
    if (hasError) return;
        
    try {
      const method = customerId ? 'PUT' : 'POST';
      const url = customerId
        ? `${API_BASE}/athlete/update/${customerId}`
        : `${API_BASE}/athlete/create`;

      const response = await fetch(url, {
        method,
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          first_name,
          last_name,
          email: email,
          phone: phone,
          user_id: userId
        }),
      });

      const data = await response.json();
      if (response.ok) {
        // Show "Saved" on the button for 2 seconds
        const saveBtn = document.getElementById('saveInfoBtn');
        if (saveBtn) {
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Saved!';
          saveBtn.disabled = true;
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }, 2500); // 2 seconds
        }
        getUserDetails(); // <-- Update welcome message
        if (!customerId) customerId = data.customer.id;
        
        // Make email field readonly and styled as locked
        const emailField = document.getElementById('email');
        if (emailField) {
          emailField.setAttribute('readonly', true);
          emailField.classList.remove('editing');
          emailField.classList.add('locked-input');
        }
  
      } else {
        showGlobalPopup('Error: ' + data.error);
      }
    } catch (error) {
      console.error('Fetch error:', error);
      showGlobalPopup('Something went wrong saving profile!');
    }
  });

  async function loadAthleteData() {
    if (!customerId) return;

    try {
      const res = await fetch(`${API_BASE}/athlete/${customerId}`, { credentials: 'include' });
      const athletes = await res.json();

      const container = document.querySelector('.athlete-box-container');
      const original = document.querySelector('.athlete-box');
      const addButton = document.querySelector('.add-athlete-box');

      // Remove all clones (except the original template)
      container.querySelectorAll('.athlete-box:not(:first-child)').forEach(el => el.remove());

      // Populate original box with first athlete or reset
      if (athletes.length > 0) {
        const first = athletes[0];
        const form = original.querySelector('form');
        form.dataset.athleteId = first.id; // Save athlete ID for updates

        form.querySelector('input[name="athleteName"]').value = `${first.first_name} ${first.last_name}`;
        form.querySelector('select[name="ageGroup"]').value = first.age_group;
        form.querySelector('select[name="sport"]').value = first.sport;
      }

      // Add additional athlete forms
      for (let i = 1; i < athletes.length; i++) {
        const athlete = athletes[i];
        const clone = original.cloneNode(true);
        const form = clone.querySelector('form');

        form.dataset.athleteId = athlete.id;
        form.addEventListener('submit', handleAthleteSubmit);

        form.querySelector('input[name="athleteName"]').value = `${athlete.first_name} ${athlete.last_name}`;
        form.querySelector('select[name="ageGroup"]').value = athlete.age_group;
        form.querySelector('select[name="sport"]').value = athlete.sport;

        // Add delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<span class="material-symbols-outlined">close</span>';
        deleteBtn.className = 'delete-athlete-btn';
        deleteBtn.style = 'position:absolute; top:-5px; right:-12.5px; background:none; border:none; font-size:30px; color:#ff4800; cursor:pointer;';
        deleteBtn.onmouseover = () => deleteBtn.style.color = 'red';
        deleteBtn.onmouseout = () => deleteBtn.style.color = '#ff4800';

        deleteBtn.addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete this athlete?')) {
            await deleteAthlete(athlete.id);
            clone.remove();
          }
        });

        clone.appendChild(deleteBtn);
        container.appendChild(clone);
        container.appendChild(addButton); // Ensure it's always the last element

        form.addEventListener('submit', handleAthleteSubmit);
      }
    } catch (err) {
      console.error('Error loading athletes:', err);
    }
  }

  function toggleSidebar() {
    const sidebar = document.getElementById("profileSidebar");
    sidebar.style.display = sidebar.style.display === "block" ? "none" : "block";
  }

  document.getElementById("profileBtn").onclick = toggleSidebar;

  // Hide sidebar when clicking outside
  document.addEventListener("click", function (event) {
    const sidebar = document.getElementById("profileSidebar");
    const profileBtn = document.getElementById("profileBtn");
    if (
      sidebar.style.display === "block" &&
      !sidebar.contains(event.target) &&
      !(profileBtn && profileBtn.contains(event.target))
    ) {
      sidebar.style.display = "none";
    }
  });

  async function handleLogout() {
    try {
      // Hit your logout route to clear the cookie

      fetch(`${API_BASE}/auth/logout`, {
        method: 'POST',
        credentials: 'include'
      });
    } catch (err) {
      console.error("Logout request failed:", err);
    }

    // Clear frontend tokens
    sessionStorage.clear();

    // Redirect to homepage
    window.location.href = "/";
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadCustomerData();
    await loadAthleteData();
    await loadPaidPackages();

    // Show first login popup if needed (customerData is now ready)
    const isFirstLogin = sessionStorage.getItem("isFirstLogin");
    if (isFirstLogin === "true") {
      let firstName = customerData && customerData.first_name ? customerData.first_name : "";
      document.getElementById("firstLoginName").textContent = firstName;
      document.getElementById("firstLoginPopup").style.display = "block";
      sessionStorage.removeItem("isFirstLogin");
    }

    document.getElementById("logoutBtn")?.addEventListener("click", function(e) {
      e.preventDefault();
      handleLogout();
    });
    document.getElementById("sidebarLogoutBtn")?.addEventListener("click", function(e) {
      e.preventDefault();
      handleLogout();
    });

    //Bind submit event to the first athlete form
    setTimeout(() => {
      const firstAthleteForm = document.querySelector('.athlete-box form');
      if (firstAthleteForm) {
        firstAthleteForm.addEventListener('submit', handleAthleteSubmit);
      }
    }, 0);

    const emailField = document.getElementById('email');
    const emailEditPopup = document.getElementById('emailEditPopup');
    const emailEditConfirmBtn = document.getElementById('emailEditConfirmBtn');
    const emailEditCancelBtn = document.getElementById('emailEditCancelBtn');

    emailField.addEventListener('click', () => {
      if (emailField.hasAttribute('readonly')) {
        // Show styled popup instead of confirm()
        emailEditPopup.style.display = 'block';
      }
    });

    emailEditConfirmBtn.onclick = function() {
      emailEditPopup.style.display = 'none';
      emailField.removeAttribute('readonly');
      emailField.classList.remove('locked-input');
      emailField.classList.add('editing');
      emailField.focus();
    };
    emailEditCancelBtn.onclick = function() {
      emailEditPopup.style.display = 'none';
    };
  });



  async function autofillParentInfoIfFirstLogin() {
    if (localStorage.getItem("parentAutofilled") === "true") {
      return; // Already autofilled once
    }

    try {
      const res = await fetch(`${API_BASE}/athlete/me`, {
        method: 'GET',
        credentials: 'include'
      });

      if (!res.ok) return;

      const data = await res.json();

      // Only autofill if fields are empty (don't overwrite user edits)
      const firstNameInput = document.getElementById("parentFirstName");
      const lastNameInput = document.getElementById("parentLastName");
      const emailInput = document.getElementById("parentEmail");

      if (firstNameInput && !firstNameInput.value) firstNameInput.value = data.first_name || "";
      if (lastNameInput && !lastNameInput.value) lastNameInput.value = data.last_name || "";
      if (emailInput && !emailInput.value) emailInput.value = data.email || "";

      // Set flag so this logic only runs once
      localStorage.setItem("parentAutofilled", "true");
    } catch (err) {
      console.error("Failed to autofill parent info", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    autofillParentInfoIfFirstLogin();
  });

  document.addEventListener("DOMContentLoaded", function() {
    if (window.location.hash === "#bookSessions") {
      setTimeout(() => {
        const el = document.getElementById("bookSessions");
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "start" });
          // Optionally scroll a bit more:
          setTimeout(() => window.scrollBy(0, 100), 400); // scroll 100px lower
        }
      }, 300);
    }
  });

  function showAthleteErrorPopup(message) {
    document.getElementById('athleteErrorMessage').textContent = message;
    document.getElementById('athleteErrorPopup').style.display = 'block';
  }
  function closeAthleteErrorPopup() {
    document.getElementById('athleteErrorPopup').style.display = 'none';
  }

  let pendingRedirect = null;

  function showGlobalPopup(message, redirectUrl = null) {
    const iconSpan = document.getElementById('globalPopupIcon');
    if (
      message.toLowerCase().includes('error') ||
      message.toLowerCase().includes('failed') ||
      message.toLowerCase().includes('not authorized') ||
      message.toLowerCase().includes('unauthorized') ||
      message.toLowerCase().includes('delete')
    ) {
      iconSpan.innerHTML = '&#9888;'; // ⚠
      iconSpan.style.display = 'inline';
    } else {
      iconSpan.innerHTML = '';
      iconSpan.style.display = 'none';
    }
    document.getElementById('globalPopupMessage').innerText = message;
    document.getElementById('globalPopup').style.display = 'block';

    // Set redirect flag if needed
    pendingRedirect = redirectUrl;
  }
  function closeGlobalPopup() {
    document.getElementById('globalPopup').style.display = 'none';
    if (pendingRedirect) {
      window.location.href = pendingRedirect;
      pendingRedirect = null;
    }
  }

</script>

<div id="firstLoginPopup" class="popup-modal">
  <p id="firstLoginMessage">
    Welcome, <span id="firstLoginName" style="color:#ff4800; font-weight:bold;"></span>! Please complete your profile before exploring packages.
  </p>
  <button onclick="closeFirstLoginPopup()">OK</button>
</div>

<div id="athleteErrorPopup" class="popup-modal">
  <span class="icon">&#9888;</span>
  <span id="athleteErrorMessage"></span>
  <br>
  <button onclick="closeAthleteErrorPopup()">OK</button>
</div>

<div id="globalPopup" class="popup-modal">
  <span id="globalPopupIcon" class="icon"></span>
  <span id="globalPopupMessage"></span>
  <br>
  <button onclick="closeGlobalPopup()">OK</button>
</div>

<!-- Email Edit Confirmation Popup -->
<div id="emailEditPopup" class="popup-modal">
  <span class="icon">&#9888;</span>
  <span id="emailEditPopupMessage">
    <br>Your email is used both to log in and to receive notifications.
    Changing it will update both.<br><br>
    Continue?
  </span>
  <br>
  <button id="emailEditConfirmBtn">Yes, Edit Email</button>
  <button id="emailEditCancelBtn" style="margin-left:10px;">Cancel</button>
</div>

</body>
</html>
